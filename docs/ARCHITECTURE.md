# üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ Lottery Bot

## –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

- [–û–±–∑–æ—Ä](#–æ–±–∑–æ—Ä)
- [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ-–ø—Ä–∏–Ω—Ü–∏–ø—ã)
- [–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã](#–∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã-—Å–∏—Å—Ç–µ–º—ã)
- [–ü–æ—Ç–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö](#–ø–æ—Ç–æ–∫–∏-–¥–∞–Ω–Ω—ã—Ö)
- [–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö](#–±–∞–∑–∞-–¥–∞–Ω–Ω—ã—Ö)
- [–ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ](#–º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ)

## –û–±–∑–æ—Ä

Lottery Bot –ø–æ—Å—Ç—Ä–æ–µ–Ω –Ω–∞ –º–æ–¥—É–ª—å–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ —Å —á–µ—Ç–∫–∏–º —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –º–µ–∂–¥—É –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏.

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                     Users / Admins                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
             ‚îÇ                          ‚îÇ
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ  Telegram Bot   ‚îÇ        ‚îÇ   Web Panel     ‚îÇ
    ‚îÇ   (aiogram)     ‚îÇ        ‚îÇ    (Flask)      ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
             ‚îÇ                          ‚îÇ
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ           Services Layer                   ‚îÇ
    ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
    ‚îÇ  ‚îÇ Lottery  ‚îÇ ‚îÇAnalytics ‚îÇ ‚îÇ  Fraud   ‚îÇ  ‚îÇ
    ‚îÇ  ‚îÇ Broadcast‚îÇ ‚îÇ  Photo   ‚îÇ ‚îÇ  Notify  ‚îÇ  ‚îÇ
    ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
             ‚îÇ
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ  Data Layer     ‚îÇ
    ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
    ‚îÇ  ‚îÇ SQLite   ‚îÇ   ‚îÇ
    ‚îÇ  ‚îÇ+ Cache   ‚îÇ   ‚îÇ
    ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã

### 1. –°–ª–æ–∏—Å—Ç–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

**Presentation Layer (–°–ª–æ–π –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è)**
- `bot/handlers/` - –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ Telegram —Å–æ–æ–±—â–µ–Ω–∏–π
- `web/routes/` - –º–∞—Ä—à—Ä—É—Ç—ã –≤–µ–±-–ø–∞–Ω–µ–ª–∏
- `bot/keyboards/` - –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –±–æ—Ç–∞

**Business Logic Layer (–ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞)**
- `services/` - —Å–µ—Ä–≤–∏—Å—ã –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏
- –ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω—ã –æ—Ç –¥–µ—Ç–∞–ª–µ–π –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è
- –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –º–µ–∂–¥—É bot –∏ web

**Data Access Layer (–î–æ—Å—Ç—É–ø –∫ –¥–∞–Ω–Ω—ã–º)**
- `database/repositories.py` - —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
- `database/connection.py` - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è–º–∏
- –ê–±—Å—Ç—Ä–∞–∫—Ü–∏—è –Ω–∞–¥ SQLite

### 2. –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏

–ö–∞–∂–¥—ã–π –º–æ–¥—É–ª—å –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –æ–¥–Ω—É –∑–∞–¥–∞—á—É:

```python
# ‚ùå –ü–ª–æ—Ö–æ: –≤—Å–µ –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ
async def handle_registration(message):
    # –í–∞–ª–∏–¥–∞—Ü–∏—è
    # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î
    # –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    # –ê–Ω–∞–ª–∏—Ç–∏–∫–∞
    pass

# ‚úÖ –•–æ—Ä–æ—à–æ: —Ä–∞–∑–¥–µ–ª–µ–Ω–Ω–∞—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å
async def handle_registration(message):
    data = await validator.validate(message)
    await repository.save(data)
    await notification_service.notify(user_id)
    await analytics.track_event("registration", user_id)
```

### 3. Dependency Injection

–°–µ—Ä–≤–∏—Å—ã –ø–æ–ª—É—á–∞—é—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä:

```python
class RegistrationHandler:
    def __init__(self, upload_dir: Path, cache, bot):
        self.upload_dir = upload_dir
        self.cache = cache
        self.bot = bot
```

### 4. Singleton Pattern –¥–ª—è —Å–µ—Ä–≤–∏—Å–æ–≤

```python
# –ì–ª–æ–±–∞–ª—å–Ω—ã–π singleton –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∏–∑ –ª—é–±–æ–π —Ç–æ—á–∫–∏
_notification_service: Optional[NotificationService] = None

def get_notification_service() -> NotificationService:
    if _notification_service is None:
        raise RuntimeError("Service not initialized")
    return _notification_service
```

## –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã

### 1. Bot Layer (bot/)

#### Handlers (bot/handlers/)

**registration.py** - –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- FSM-based —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è (4 —à–∞–≥–∞)
- –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ –∫–∞–∂–¥–æ–º —à–∞–≥–µ
- –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
- Inline –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ

**support.py** - –°–∏—Å—Ç–µ–º–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏
- –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∏–∫–µ—Ç–æ–≤
- –ü—Ä–æ—Å–º–æ—Ç—Ä –∏—Å—Ç–æ—Ä–∏–∏
- FAQ

**common.py** - –û–±—â–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
- –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é

**global_commands.py** - –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
- /start, /help, /menu
- –î–æ—Å—Ç—É–ø–Ω—ã –∏–∑ –ª—é–±–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è

#### Middleware (bot/middleware/)

**rate_limit.py** - Rate Limiting
```python
class RateLimitMiddleware:
    """–û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç —á–∞—Å—Ç–æ—Ç—É –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
    def __init__(self, rate_limit: int = 30):
        self.rate_limit = rate_limit  # requests per minute
```

**fsm_logger.py** - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ FSM –ø–µ—Ä–µ—Ö–æ–¥–æ–≤
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–π
- –û—Ç–ª–∞–¥–∫–∞ –ø–æ—Ç–æ–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

#### Keyboards (bot/keyboards/)

**main_menu.py** - –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—Ç–∞—Ç—É—Å–∞
- –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏

**smart_keyboards.py** - –£–º–Ω—ã–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
- Contact sharing
- Location sharing
- Inline –∫–Ω–æ–ø–∫–∏

### 2. Services Layer (services/)

#### LotteryService (lottery.py)

**–§—É–Ω–∫—Ü–∏–∏:**
- –ö—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏ —á–µ—Å—Ç–Ω—ã–π —Ä–æ–∑—ã–≥—Ä—ã—à
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è seed –Ω–∞ –æ—Å–Ω–æ–≤–µ –±–ª–æ–∫—á–µ–π–Ω —Ö–µ—à–∞
- –î–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≤—ã–±–æ—Ä –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π

**–ê–ª–≥–æ—Ä–∏—Ç–º:**
```python
def draw_winners(participants, seed):
    random.seed(seed)
    return random.sample(participants, k=num_winners)
```

#### BroadcastService (broadcast.py)

**–§—É–Ω–∫—Ü–∏–∏:**
- –ú–∞—Å—Å–æ–≤–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –º–µ–¥–∏–∞ (—Ñ–æ—Ç–æ, –≤–∏–¥–µ–æ)
- Retry –ª–æ–≥–∏–∫–∞ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- Tracking —Å—Ç–∞—Ç—É—Å–∞ –¥–æ—Å—Ç–∞–≤–∫–∏

**Queue-based –ø–æ–¥—Ö–æ–¥:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Job      ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ Queue    ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ Sent     ‚îÇ
‚îÇ Created  ‚îÇ     ‚îÇ Pending  ‚îÇ     ‚îÇ Success  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                       ‚îÇ
                       ‚ñº
                 ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                 ‚îÇ Failed   ‚îÇ
                 ‚îÇ+ Retry   ‚îÇ
                 ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

#### CacheService (cache.py)

**–ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ:**

```python
class MultiLevelCache:
    hot_tier   # Fast, short TTL (60s)
    warm_tier  # Medium TTL (5min)
    cold_tier  # Long TTL (1h)
```

**–°—Ç—Ä–∞—Ç–µ–≥–∏—è:**
- Hot tier: –ß–∞—Å—Ç–æ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ (—Å—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
- Warm tier: –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ–º—ã–µ (—Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤)
- Cold tier: –†–µ–¥–∫–æ –º–µ–Ω—è—é—â–∏–µ—Å—è (FAQ)

#### AnalyticsService (analytics_service.py)

**–°–æ–±—ã—Ç–∏—è:**
- `REGISTRATION_STARTED` - –ù–∞—á–∞–ª–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
- `REGISTRATION_STEP_COMPLETED` - –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —à–∞–≥–∞
- `REGISTRATION_COMPLETED` - –£—Å–ø–µ—à–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
- `BUTTON_CLICKED` - –ö–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ
- `ERROR_OCCURRED` - –í–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–µ –æ—à–∏–±–∫–∏

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```python
await AnalyticsService.track_event(
    AnalyticsEvent.REGISTRATION_STARTED,
    user_id=user_id,
    properties={"source": "referral"}
)
```

#### FraudDetectionService (fraud_detection_service.py)

**–ü—Ä–æ–≤–µ—Ä–∫–∏:**
1. –°–∫–æ—Ä–æ—Å—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (< 15 —Å–µ–∫ = –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ)
2. –î—É–±–ª–∏–∫–∞—Ç—ã —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤/–∫–∞—Ä—Ç
3. –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏
4. –ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –≤ –¥–∞–Ω–Ω—ã—Ö
5. –í—ã—Å–æ–∫–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å

**Scoring:**
```
0.0 - 0.4: Safe
0.5 - 0.7: Suspicious (warning)
0.8 - 1.0: High risk (block)
```

#### NotificationService (notification_service.py)

**–¢–∏–ø—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:**
- –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞—è–≤–∫–∏
- –û—Ç–≤–µ—Ç –Ω–∞ —Ç–∏–∫–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏
- –ü–æ–±–µ–¥–∞ –≤ —Ä–æ–∑—ã–≥—Ä—ã—à–µ
- –°–∏—Å—Ç–µ–º–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

#### PhotoUploadService (photo_upload_service.py)

**–§—É–Ω–∫—Ü–∏–∏:**
- Retry –º–µ—Ö–∞–Ω–∏–∑–º (3 –ø–æ–ø—ã—Ç–∫–∏)
- Exponential backoff
- –í–∞–ª–∏–¥–∞—Ü–∏—è —Ä–∞–∑–º–µ—Ä–∞
- –ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Ñ–∞–π–ª–æ–≤

### 3. Database Layer (database/)

#### Connection Pool (connection.py)

```python
class OptimizedSQLitePool:
    """–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π."""
    def __init__(self, pool_size: int = 10):
        self.pool_size = pool_size
        self.connections = []
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- WAL mode –¥–ª—è concurrent reads
- Connection pooling
- Automatic retry –ø—Ä–∏ busy

#### Repositories (repositories.py)

**Pattern: Repository**
```python
async def get_participant_status(telegram_id: int):
    """–ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å —É—á–∞—Å—Ç–Ω–∏–∫–∞."""
    # –ò–∑–æ–ª—è—Ü–∏—è SQL-–ª–æ–≥–∏–∫–∏
```

**Batch Operations:**
```python
async def insert_participants_batch(records: List[Dict]):
    """–ú–∞—Å—Å–æ–≤–∞—è –≤—Å—Ç–∞–≤–∫–∞ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏."""
    # 25 –∑–∞–ø–∏—Å–µ–π –∑–∞ —Ä–∞–∑
```

#### Migrations (migrations.py)

**–í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ö–µ–º—ã:**
```python
SCHEMA_SQL = (
    "CREATE TABLE IF NOT EXISTS participants ...",
    "CREATE INDEX IF NOT EXISTS idx_participants_status ...",
    # ...
)
```

### 4. Web Layer (web/)

#### Flask Application (app.py)

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
- Flask app —Å blueprint-based routing
- CSRF protection
- Session management
- Error handlers (404, 500)

#### Routes (web/routes/)

**admin.py** - –û—Å–Ω–æ–≤–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã
- Dashboard
- Participants management
- Lottery management
- Broadcasts
- Support tickets
- System logs

**health.py** - Health checks
- `/health` - –ë–∞–∑–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
- `/health/db` - –ü—Ä–æ–≤–µ—Ä–∫–∞ –ë–î
- `/health/detailed` - –î–µ—Ç–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞

#### Templates (web/templates/)

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
- Jinja2 templating
- Bootstrap 5 –¥–ª—è UI
- Font Awesome –∏–∫–æ–Ω–∫–∏
- Custom CSS –¥–ª—è –±—Ä–µ–Ω–¥–∏–Ω–≥–∞

## –ü–æ—Ç–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö

### –ü–æ—Ç–æ–∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏

```
User                   Bot Handler              Services              Database
  ‚îÇ                         ‚îÇ                       ‚îÇ                     ‚îÇ
  ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"–ù–∞—á–∞—Ç—å"‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ                       ‚îÇ                     ‚îÇ
  ‚îÇ                         ‚îÇ                       ‚îÇ                     ‚îÇ
  ‚îÇ                         ‚îÇ‚îÄ‚îÄtrack_event()‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ                     ‚îÇ
  ‚îÇ                         ‚îÇ                       ‚îÇ‚îÄ‚îÄINSERT analytics‚îÄ‚îÄ‚ñ∂‚îÇ
  ‚îÇ                         ‚îÇ                       ‚îÇ                     ‚îÇ
  ‚îÇ‚óÄ‚îÄ‚îÄ‚îÄ‚îÄ"–í–≤–µ–¥–∏—Ç–µ –∏–º—è"‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ                       ‚îÇ                     ‚îÇ
  ‚îÇ                         ‚îÇ                       ‚îÇ                     ‚îÇ
  ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤"‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ                       ‚îÇ                     ‚îÇ
  ‚îÇ                         ‚îÇ‚îÄ‚îÄvalidate_name()‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ                     ‚îÇ
  ‚îÇ                         ‚îÇ                       ‚îÇ                     ‚îÇ
  ‚îÇ                         ‚îÇ‚îÄ‚îÄsave_state()‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ                     ‚îÇ
  ‚îÇ                         ‚îÇ                       ‚îÇ‚îÄ‚îÄINSERT state‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ
  ‚îÇ                         ‚îÇ                       ‚îÇ                     ‚îÇ
  ‚îÇ‚óÄ‚îÄ‚îÄ‚îÄ‚îÄ"–í–≤–µ–¥–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω"‚îÄ‚îÄ‚îÄ‚îÇ                       ‚îÇ                     ‚îÇ
  ‚îÇ         ...             ‚îÇ          ...          ‚îÇ        ...          ‚îÇ
  ‚îÇ                         ‚îÇ                       ‚îÇ                     ‚îÇ
  ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ                       ‚îÇ                     ‚îÇ
  ‚îÇ                         ‚îÇ‚îÄ‚îÄcheck_fraud()‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ                     ‚îÇ
  ‚îÇ                         ‚îÇ                       ‚îÇ‚îÄ‚îÄSELECT duplicates‚îÄ‚ñ∂‚îÇ
  ‚îÇ                         ‚îÇ                       ‚îÇ‚óÄ‚îÄ‚îÄ‚îÄ‚îÄresults‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ
  ‚îÇ                         ‚îÇ‚óÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄfraud_score‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ                     ‚îÇ
  ‚îÇ                         ‚îÇ                       ‚îÇ                     ‚îÇ
  ‚îÇ                         ‚îÇ‚îÄ‚îÄinsert_participant()‚îÄ‚ñ∂                     ‚îÇ
  ‚îÇ                         ‚îÇ                       ‚îÇ‚îÄ‚îÄINSERT participant‚ñ∂‚îÇ
  ‚îÇ                         ‚îÇ                       ‚îÇ                     ‚îÇ
  ‚îÇ‚óÄ‚îÄ‚îÄ‚îÄ‚îÄ"–£—Å–ø–µ—Ö!"‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ                       ‚îÇ                     ‚îÇ
```

### –ü–æ—Ç–æ–∫ —Ä–æ–∑—ã–≥—Ä—ã—à–∞

```
Admin Panel            Lottery Service         Database
     ‚îÇ                       ‚îÇ                     ‚îÇ
     ‚îÇ‚îÄ‚îÄ"Run Lottery"‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ                     ‚îÇ
     ‚îÇ   (10 winners)        ‚îÇ                     ‚îÇ
     ‚îÇ                       ‚îÇ‚îÄ‚îÄget_approved()‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ
     ‚îÇ                       ‚îÇ‚óÄ‚îÄ‚îÄ‚îÄparticipants‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ
     ‚îÇ                       ‚îÇ                     ‚îÇ
     ‚îÇ                       ‚îÇ‚îÄ‚îÄgenerate_seed()    ‚îÇ
     ‚îÇ                       ‚îÇ  (blockchain hash)  ‚îÇ
     ‚îÇ                       ‚îÇ                     ‚îÇ
     ‚îÇ                       ‚îÇ‚îÄ‚îÄdraw_winners()     ‚îÇ
     ‚îÇ                       ‚îÇ  (deterministic)    ‚îÇ
     ‚îÇ                       ‚îÇ                     ‚îÇ
     ‚îÇ                       ‚îÇ‚îÄ‚îÄsave_winners()‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ
     ‚îÇ                       ‚îÇ                     ‚îÇ‚îÄ‚îÄINSERT winners
     ‚îÇ                       ‚îÇ                     ‚îÇ‚îÄ‚îÄINSERT lottery_run
     ‚îÇ                       ‚îÇ                     ‚îÇ
     ‚îÇ‚óÄ‚îÄ‚îÄwinners_list‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ                     ‚îÇ
     ‚îÇ                       ‚îÇ                     ‚îÇ
     ‚îÇ‚îÄ‚îÄ"Notify winners"‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ                     ‚îÇ
     ‚îÇ                       ‚îÇ‚îÄ‚îÄnotify_service()   ‚îÇ
     ‚îÇ                       ‚îÇ    (async)          ‚îÇ
```

## –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### –°—Ö–µ–º–∞

```sql
-- Participants (–£—á–∞—Å—Ç–Ω–∏–∫–∏)
CREATE TABLE participants (
    id INTEGER PRIMARY KEY,
    telegram_id BIGINT UNIQUE NOT NULL,
    full_name TEXT NOT NULL,
    phone_number TEXT UNIQUE NOT NULL,
    loyalty_card TEXT UNIQUE NOT NULL,
    photo_path TEXT,
    status TEXT DEFAULT 'pending',  -- pending, approved, rejected
    registration_date TIMESTAMP,
    admin_notes TEXT
);

-- Winners (–ü–æ–±–µ–¥–∏—Ç–µ–ª–∏)
CREATE TABLE winners (
    id INTEGER PRIMARY KEY,
    run_id INTEGER NOT NULL,
    participant_id INTEGER NOT NULL,
    position INTEGER,
    prize_description TEXT,
    lottery_date TIMESTAMP,
    FOREIGN KEY(run_id) REFERENCES lottery_runs(id),
    FOREIGN KEY(participant_id) REFERENCES participants(id)
);

-- Lottery Runs (–†–æ–∑—ã–≥—Ä—ã—à–∏)
CREATE TABLE lottery_runs (
    id INTEGER PRIMARY KEY,
    seed TEXT NOT NULL,
    executed_at TIMESTAMP,
    winners_count INTEGER NOT NULL
);

-- Analytics Events (–ê–Ω–∞–ª–∏—Ç–∏–∫–∞)
CREATE TABLE analytics_events (
    id INTEGER PRIMARY KEY,
    event_type TEXT NOT NULL,
    user_id INTEGER,
    properties TEXT,  -- JSON
    timestamp TEXT NOT NULL
);

-- Fraud Log (–ñ—É—Ä–Ω–∞–ª –º–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–∞)
CREATE TABLE fraud_log (
    id INTEGER PRIMARY KEY,
    user_id INTEGER NOT NULL,
    activity_type TEXT NOT NULL,
    details TEXT,  -- JSON
    detected_at TIMESTAMP
);

-- Registration States (–°–æ—Å—Ç–æ—è–Ω–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏)
CREATE TABLE registration_states (
    user_id INTEGER PRIMARY KEY,
    state_data TEXT NOT NULL,  -- JSON
    updated_at TEXT NOT NULL
);
```

### –ò–Ω–¥–µ–∫—Å—ã

```sql
-- Performance indexes
CREATE INDEX idx_participants_status ON participants(status);
CREATE INDEX idx_participants_telegram_id ON participants(telegram_id);
CREATE INDEX idx_analytics_events_user_id ON analytics_events(user_id);
CREATE INDEX idx_fraud_log_user ON fraud_log(user_id, detected_at);
```

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

1. **WAL Mode** - Concurrent reads –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
2. **Connection Pooling** - –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
3. **Batch Inserts** - –î–æ 25 –∑–∞–ø–∏—Å–µ–π –∑–∞ —Ä–∞–∑
4. **Prepared Statements** - –ó–∞—â–∏—Ç–∞ –æ—Ç SQL injection

## –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ

**Telegram Bot:**
- Stateless design –ø–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤
- Long polling —Å —Ä–∞–∑–Ω—ã–º–∏ offsets
- Webhook mode –¥–ª—è production

**Web Panel:**
- Stateless Flask app
- Session –≤ Redis (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- Load balancer (Nginx/HAProxy)

### –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ

**Database:**
- SQLite ‚Üí PostgreSQL –ø—Ä–∏ > 1M –∑–∞–ø–∏—Å–µ–π
- Read replicas –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
- Sharding –ø–æ telegram_id

**Cache:**
- In-memory ‚Üí Redis cluster
- Distributed cache

### Bottlenecks

1. **SQLite write lock** - –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ ~1000 writes/sec
   - Solution: PostgreSQL –∏–ª–∏ batch writes
   
2. **Telegram API rate limits** - 30 msg/sec
   - Solution: Queue —Å throttling
   
3. **File storage** - –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ —Ñ–æ—Ç–æ
   - Solution: S3-compatible storage

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

**–ú–µ—Ç—Ä–∏–∫–∏:**
- Request rate (bot commands/sec)
- Response time (percentiles: p50, p95, p99)
- Error rate (%)
- Queue length (broadcast queue)
- Cache hit rate (%)
- DB connection pool utilization

**Alerts:**
- Error rate > 5%
- Response time p95 > 5s
- Queue length > 1000
- DB connections exhausted

### Disaster Recovery

**Backup Strategy:**
1. Daily automated SQLite backups
2. Incremental backups –∫–∞–∂–¥—ã–π —á–∞—Å
3. Off-site backup storage
4. Point-in-time recovery –¥–æ 7 –¥–Ω–µ–π

**Recovery Plan:**
1. Restore database from backup
2. Verify data integrity
3. Restart services
4. Test critical paths
5. Monitor for issues

---

## –î–∞–ª—å–Ω–µ–π—à–µ–µ —Ä–∞–∑–≤–∏—Ç–∏–µ

### –ü–ª–∞–Ω–∏—Ä—É–µ–º—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

1. **WebSocket –¥–ª—è real-time updates**
2. **GraphQL API** –¥–ª—è mobile apps
3. **–ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞** –¥–ª—è –∫—Ä—É–ø–Ω—ã—Ö –∏–Ω—Å—Ç–∞–ª–ª—è—Ü–∏–π
4. **Event-driven architecture** —Å message broker
5. **AI-powered fraud detection** —Å ML –º–æ–¥–µ–ª—è–º–∏

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –¥–æ–ª–≥

- [ ] –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –¥–ª–∏–Ω–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π –≤ registration.py
- [ ] –î–æ–±–∞–≤–∏—Ç—å integration tests
- [ ] –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ API endpoints
- [ ] –ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ async SQLAlchemy
- [ ] –î–æ–±–∞–≤–∏—Ç—å OpenAPI —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—é

---

<p align="center">–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∞–∫—Ç—É–∞–ª—å–Ω–∞ –¥–ª—è –≤–µ—Ä—Å–∏–∏ 2.0.0</p>
