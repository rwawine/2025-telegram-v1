# Техническая документация системы розыгрыша призов

## 1. Общее описание системы

### Назначение и цели системы
Система управляет розыгрышем призов с регистрацией участников через Telegram-бот, модерацией заявок и админ-панелью для администраторов.

**Основные цели:**
- Безопасный сбор заявок от участников
- Модерация и статус-менеджмент заявок
- Проведение честного криптографически защищенного розыгрыша
- Коммуникация с участниками (рассылки, уведомления)
- Обработка обращений в техническую поддержку
- Экспорт данных для аналитики

### Основные пользовательские роли
- **Администратор**: доступ к веб-админке через IP-адрес сервера, управление участниками, розыгрышами, рассылками и тикетами поддержки
- **Модератор**: в текущей версии функционально совпадает с администратором (все защищённые разделы требуют авторизации)
- **Пользователь**: участник розыгрыша, взаимодействует только через Telegram-бот

### Общая архитектура системы

**Основные компоненты:**
- **Telegram-бот**: основной скрипт `main.py`, обработчики в `handlers/`, клавиатуры в `keyboards/`
- **Веб-админка (Flask)**: встроенный веб-сервер, шаблоны в `templates/`, статика в `static/`
- **База данных**: Оптимизированная система хранения для высоких нагрузок (см. раздел "Производительность и масштабирование")
- **Модуль лотереи**: криптографическая генерация, детерминированный выбор победителей
- **Система рассылок**: управление массовыми сообщениями
- **Файловое хранилище**: папка `uploads/` для фото, `logs/` для логов

**Развертывание:**
- Единый процесс Python запускается командой `python main.py`
- Веб-интерфейс доступен по IP-адресу сервера (например: `http://YOUR_VPS_IP:5000`)
- Telegram-бот работает в режиме polling с поддержкой высоких нагрузок
- Оптимизированная работа с БД для обслуживания 10000+ участников

## 2. Пользовательский интерфейс

### Веб-интерфейс администратора (доступ по IP)

**Точка входа:** `http://YOUR_VPS_IP:5000`

**Основные страницы:**
- **Авторизация** (`/login`) - вход по логину и паролю
- **Дашборд** (`/`) - главная страница со статистикой
- **Участники** (`/participants`) - список и управление участниками
- **Розыгрыш** (`/lottery`) - проведение розыгрышей
- **Рассылки** (`/broadcasts`) - массовые сообщения
- **Поддержка** (`/support_tickets`) - обращения пользователей
- **Настройки** (`/settings`) - конфигурация системы (read-only)

### Telegram-бот интерфейс

**Главное меню:**
- Начать регистрацию
- Мой статус
- Техподдержка
- О розыгрыше
- Помощь

**Процесс регистрации (4 шага):**
1. Ввод имени
2. Отправка телефона (кнопка или ручной ввод)
3. Ввод номера карты лояльности
4. Загрузка фото лифлета

## 3. Административная панель

### Доступ к панели
- URL: `http://YOUR_VPS_IP:5000/login`
- Авторизация по логину/паролю
- Все разделы защищены авторизацией

### Функционал управления

**Участники:**
- Просмотр списка с фильтрацией
- Изменение статусов (pending/approved/rejected)
- Массовые операции
- Просмотр загруженных фото
- Экспорт в CSV/XLSX

**Розыгрыш:**
- Установка количества победителей
- Криптографически защищенный выбор
- История розыгрышей
- Перерозыгрыш отдельных позиций

**Рассылки:**
- Создание сообщений
- Выбор целевой аудитории
- Отслеживание статуса отправки
- Шаблоны сообщений

**Поддержка:**
- Просмотр тикетов
- Ответы пользователям
- Изменение статусов обращений
- История переписки

## 4. Бизнес-логика

### Ключевые процессы

**Регистрация участника:**
1. Пользователь запускает бота
2. Проходит пошаговую регистрацию
3. Данные сохраняются со статусом "pending"
4. Администратор модерирует заявку

**Модерация:**
1. Админ просматривает новые заявки
2. Проверяет корректность данных и фото
3. Одобряет или отклоняет с указанием причины
4. Участник получает уведомление

**Розыгрыш:**
1. Формируется пул участников (status='approved')
2. Генерируется криптографическое семя
3. Детерминированно выбираются победители
4. Сохраняется снимок состояния
5. Победители уведомляются

### Правила и ограничения
- Уникальность телефона и карты лояльности
- Один участник - один выигрыш
- Размер фото до 10MB
- Поддерживаемые форматы: JPG, PNG

## 5. Безопасность

### Меры защиты
- Хешированные пароли администраторов
- CSRF-защита форм
- Ограничение размера загружаемых файлов
- Валидация путей при доступе к файлам
- Rate limiting для критичных операций

### Доступ к системе
- Веб-интерфейс доступен только по IP сервера
- Нет публичного домена - снижает риски атак
- Рекомендуется использовать VPN для доступа админов
- Возможно ограничение доступа по IP через firewall

## 6. Конфигурация системы

### Основные параметры (переменные окружения)

```
# Telegram бот
BOT_TOKEN=your_bot_token
ADMIN_IDS=telegram_id1,telegram_id2

# Веб-интерфейс
WEB_HOST=0.0.0.0  # Слушает на всех интерфейсах
WEB_PORT=5000      # Порт веб-сервера
SECRET_KEY=your_secret_key

# База данных
DATABASE_PATH=data/lottery_bot.sqlite

# Пути к файлам
UPLOAD_FOLDER=uploads
EXPORT_FOLDER=exports
LOG_FOLDER=logs

# Ограничения
MAX_FILE_SIZE=10485760  # 10MB
MAX_PARTICIPANTS=10000

# Первый администратор
ADMIN_USERNAME=admin
ADMIN_PASSWORD=secure_password
```

### Запуск системы

**Единая команда запуска:**
```bash
python main.py
```

Эта команда запускает:
- Telegram-бота в режиме polling
- Веб-сервер на указанном порту
- Фоновые процессы обработки

**Доступ к админке после запуска:**
```
http://YOUR_VPS_IP:5000
```

## 7. Установка и настройка

### Требования к серверу
- Python 3.8+
- 2-4GB RAM (для обработки 500-1000 одновременных пользователей)
- 20GB свободного места (с учетом роста БД до 10000 участников)
- Открытый порт 5000 (или другой указанный)
- Статический IP-адрес
- 2-4 CPU ядра для оптимальной производительности

### Шаги установки

1. **Клонирование проекта на VPS:**
```bash
git clone [repository]
cd lottery-bot
```

2. **Установка зависимостей:**
```bash
pip install -r requirements.txt
```

3. **Настройка переменных окружения:**
```bash
cp .env.example .env
nano .env  # Редактирование параметров
```

4. **Создание директорий:**
```bash
mkdir -p data uploads exports logs
```

5. **Запуск системы:**
```bash
python main.py
```

### Настройка firewall (опционально)

Для ограничения доступа к админке только с определенных IP:

```bash
# Разрешить доступ только с вашего IP
sudo ufw allow from YOUR_IP to any port 5000

# Или открыть для всех (менее безопасно)
sudo ufw allow 5000
```

## 8. Мониторинг и обслуживание

### Логирование
- Основной лог: `logs/bot.log`
- Ротация логов при достижении 10MB
- Хранение последних 5 файлов

### Health-check
- Эндпоинт: `http://YOUR_VPS_IP:5000/health`
- Проверяет доступность БД
- Возвращает базовую статистику

### Резервное копирование
```bash
# Backup базы данных
cp data/lottery_bot.sqlite backups/lottery_bot_$(date +%Y%m%d).sqlite

# Backup загруженных файлов
tar -czf backups/uploads_$(date +%Y%m%d).tar.gz uploads/
```

### Обновление системы
1. Остановить процесс (Ctrl+C)
2. Сделать backup
3. Обновить код
4. Запустить заново: `python main.py`

## 9. API эндпоинты

### Публичные (требуют авторизации)
- `GET /api/stats` - общая статистика
- `GET /api/lottery_stats` - статистика розыгрышей
- `GET /api/broadcast/<id>` - детали рассылки
- `GET /api/broadcast_recipients/<id>` - список получателей

### Внутренние
- `POST /participants/mass_update_status` - массовое обновление
- `GET /export` - экспорт данных

## 10. Производительность и масштабирование

### Требования к производительности
**ОБЯЗАТЕЛЬНЫЕ ТРЕБОВАНИЯ:**
- Система ДОЛЖНА выдерживать одновременную нагрузку от 500-1000 активных пользователей
- Общая емкость базы данных - минимум 10000 участников
- Время отклика бота не должно превышать 1-2 секунды при пиковых нагрузках
- Стабильная работа при массовых рассылках на 10000 получателей

### Варианты баз данных для высоких нагрузок

**Вариант 1: SQLite с оптимизациями (рекомендуется для начала)**
```python
# Критические настройки для SQLite при высоких нагрузках
PRAGMA journal_mode = WAL;  # Write-Ahead Logging для параллельных операций
PRAGMA synchronous = NORMAL;  # Баланс производительности и надежности
PRAGMA cache_size = -64000;  # 64MB кэш в памяти
PRAGMA temp_store = MEMORY;  # Временные таблицы в RAM
PRAGMA mmap_size = 268435456;  # 256MB memory-mapped I/O
```

**Преимущества SQLite с WAL:**
- Поддержка параллельного чтения
- Один writer, множество readers
- Достаточно для 500-1000 одновременных пользователей при правильной настройке
- Не требует отдельного сервера БД

**Вариант 2: DuckDB (современная альтернатива)**
- Встраиваемая аналитическая БД
- Превосходная производительность для чтения
- Поддержка параллельных запросов
- Совместимость с SQLite
- Идеальна для статистики и отчетов

### Архитектурные решения для высоких нагрузок

**Пул соединений с БД:**
```python
# Настройки пула соединений
CONNECTION_POOL_SIZE = 20  # Для 1000 пользователей
CONNECTION_TIMEOUT = 30  # Секунд
STATEMENT_CACHE_SIZE = 100  # Кэш подготовленных запросов
```

**Кэширование в памяти:**
- Использование Redis или встроенного LRU-кэша Python
- Кэширование частых запросов (статусы, статистика)
- TTL 30-60 секунд для динамических данных
- Прогрев кэша при старте системы

**Оптимизация Telegram-бота:**
```python
# Настройки для высоких нагрузок
TELEGRAM_RATE_LIMIT = 30  # Сообщений в секунду
WORKER_THREADS = 10  # Потоков обработки
MESSAGE_QUEUE_SIZE = 1000  # Размер очереди
BATCH_SIZE = 25  # Пакетная обработка
```

**Асинхронная обработка:**
- Использование aiogram в асинхронном режиме
- Неблокирующие операции с БД
- Очереди для тяжелых операций (загрузка фото, рассылки)

### Мониторинг производительности

**Метрики для отслеживания:**
- Количество активных пользователей в минуту
- Среднее время ответа бота
- Нагрузка на БД (запросов/сек)
- Использование памяти и CPU
- Размер очередей сообщений

**Автоматические оповещения при:**
- Время ответа > 3 секунд
- Очередь сообщений > 500
- CPU > 80%
- RAM > 80%
- Ошибки БД

### Оптимизация базы данных

**Индексы для производительности:**
```sql
-- Критические индексы для 10000+ записей
CREATE INDEX idx_participants_status ON participants(status);
CREATE INDEX idx_participants_telegram_id ON participants(telegram_id);
CREATE INDEX idx_participants_phone ON participants(phone_number);
CREATE INDEX idx_participants_registration_date ON participants(registration_date);
CREATE INDEX idx_winners_participant ON winners(participant_id);
CREATE INDEX idx_tickets_status ON support_tickets(status, created_at);
```

**Партиционирование данных:**
- Архивирование старых розыгрышей
- Разделение активных и неактивных участников
- Отдельные таблицы для логов по месяцам

### Настройка для пиковых нагрузок

**Сценарий: Старт розыгрыша (1000 одновременных проверок статуса)**
```python
# Конфигурация для пиковых нагрузок
PEAK_MODE_CACHE_TTL = 300  # 5 минут кэш
PEAK_MODE_BATCH_SIZE = 50  # Увеличенные пакеты
PEAK_MODE_QUEUE_SIZE = 2000  # Расширенная очередь
RATE_LIMIT_BURST = 50  # Всплеск до 50 запросов
```

**Graceful degradation:**
- Временное отключение неприоритетных функций
- Увеличение интервалов обновления статистики
- Отложенная обработка фото
- Приоритизация критических операций

### Тестирование производительности

**Нагрузочное тестирование:**
```bash
# Симуляция 1000 пользователей
python stress_test.py --users 1000 --duration 300

# Ожидаемые результаты:
# - 95% ответов < 1 сек
# - 99% ответов < 2 сек
# - 0% потерянных сообщений
# - Стабильное потребление памяти
```

**Профилирование узких мест:**
- Анализ медленных запросов БД
- Поиск блокировок и deadlock'ов
- Оптимизация N+1 запросов
- Выявление утечек памяти

## 11. Известные ограничения

### Текущие ограничения версии
- Нет разделения ролей администратор/модератор
- Отсутствует импорт данных
- Нет автоматического резервного копирования
- Веб-интерфейс не оптимизирован для мобильных устройств
- Один процесс обрабатывает все компоненты

### Рекомендации по масштабированию
При дальнейшем росте (свыше 10000 участников):
- Миграция на DuckDB
- Разделение бота на несколько инстансов
- Использование nginx как reverse proxy с балансировкой
- Внедрение распределенного кэша
- Горизонтальное масштабирование через sharding

**ВАЖНО:** Система проектируется и должна быть протестирована для гарантированной работы с 500-1000 одновременными пользователями и общей базой в 10000+ участников без использования PostgreSQL или MySQL.

## 12. Troubleshooting

### Частые проблемы

**Не открывается веб-интерфейс:**
- Проверить открыт ли порт 5000
- Убедиться что процесс запущен
- Проверить правильность IP-адреса

**Бот не отвечает:**
- Проверить корректность BOT_TOKEN
- Убедиться что бот не заблокирован в Telegram
- Проверить логи на ошибки

**Ошибки при загрузке фото:**
- Проверить права на папку uploads/
- Убедиться в наличии свободного места
- Проверить размер файла (макс. 10MB)

### Контакты поддержки
При возникновении проблем обращаться к системному администратору или разработчику системы.

## 12. Заключение

Система розыгрыша призов представляет собой комплексное решение, объединяющее Telegram-бота для участников и веб-интерфейс для администраторов. Простота развертывания (один процесс Python) и использование IP-адреса вместо домена делают систему легкой в установке и обслуживании на VPS.

Ключевые преимущества:
- Не требует сложной инфраструктуры
- Запускается одной командой
- Работает через IP без необходимости домена
- Встроенная база данных SQLite
- Полностью автономная система

Система готова к использованию в продуктивной среде с учетом указанных ограничений и рекомендаций по безопасности.