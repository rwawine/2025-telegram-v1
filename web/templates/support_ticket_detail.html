{% extends "base.html" %}

{% block title %}–¢–∏–∫–µ—Ç {{ ticket.ticket_number }}{% endblock %}

{% block styles %}
<style>
    .chat-container {
        max-height: 600px;
        overflow-y: auto;
    }
    .message {
        margin-bottom: 1rem;
    }
    .message .card-body {
        padding: 0.75rem 1rem;
    }
    .message.admin .card {
        background-color: var(--bs-primary-bg-subtle);
        border-color: var(--bs-primary-border-subtle);
    }
    .message.user .card {
        background-color: var(--bs-light-bg-subtle);
        border-color: var(--bs-light-border-subtle);
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2 d-flex align-items-center">
        <a href="{{ url_for('admin.support_tickets') }}" class="text-muted me-3" title="–ù–∞–∑–∞–¥ –∫ —Ç–∏–∫–µ—Ç–∞–º">
            <i class="fa-solid fa-arrow-left"></i>
        </a>
        –¢–∏–∫–µ—Ç #{{ ticket.ticket_number }}
    </h1>
    <div>
        {% set status_config = {
            'open': ('badge-light-warning', '–û—Ç–∫—Ä—ã—Ç'),
            'in_progress': ('badge-light-info', '–í —Ä–∞–±–æ—Ç–µ'),
            'resolved': ('badge-light-success', '–†–µ—à–µ–Ω'),
            'closed': ('badge-light-secondary', '–ó–∞–∫—Ä—ã—Ç')
        }.get(ticket.status, ('bg-light', ticket.status)) %}
        <span class="badge fs-6 {{ status_config[0] }}">{{ status_config[1] }}</span>
    </div>
</div>

<div class="row g-4">
    <!-- Main Content -->
    <div class="col-lg-8">
        <!-- Messages -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fa-solid fa-comments me-2"></i>–ü–µ—Ä–µ–ø–∏—Å–∫–∞ ({{ messages|length }} —Å–æ–æ–±—â–µ–Ω–∏–π)</h5>
            </div>
            <div class="card-body chat-container p-4" id="chat-container">
                {% if messages %}
                    {% for message in messages %}
                    <div class="message {% if message.sender_type == 'admin' %}admin{% else %}user{% endif %}">
                        <div class="d-flex {% if message.sender_type == 'admin' %}flex-row-reverse{% endif %} align-items-end">
                            <div class="card" style="max-width: 80%;">
                                <div class="card-body">
                                    {% if message.message_text %}
                                    <p class="mb-0">{{ message.message_text | replace('\n', '<br>') | safe }}</p>
                                    {% endif %}
                                    {% if message.attachment_file_id %}
                                    <div class="mt-2">
                                        <div class="d-flex flex-column gap-2">
                                            <a href="#" data-bs-toggle="modal" data-bs-target="#mediaModal{{ loop.index }}">
                                                <img src="{{ url_for('admin.serve_telegram_media', file_id=message.attachment_file_id) }}" 
                                                     class="img-fluid rounded border media-preview" 
                                                     style="max-width: 300px; max-height: 200px; cursor: pointer;"
                                                     onerror="this.style.display='none'; this.nextElementSibling.style.display='block';"
                                                     alt="–ú–µ–¥–∏–∞">
                                                <div class="alert alert-info mb-0 py-2 px-3" style="display: none; max-width: 300px;">
                                                    <i class="fa-solid fa-file me-2"></i>
                                                    <strong>–î–æ–∫—É–º–µ–Ω—Ç</strong>
                                                </div>
                                            </a>
                                            <a href="{{ url_for('admin.serve_telegram_media', file_id=message.attachment_file_id) }}" 
                                               target="_blank" 
                                               class="btn btn-sm btn-outline-primary" 
                                               style="max-width: 150px;">
                                                <i class="fa-solid fa-download me-1"></i>–°–∫–∞—á–∞—Ç—å
                                            </a>
                                        </div>
                                        <!-- Modal for fullsize image -->
                                        <div class="modal fade" id="mediaModal{{ loop.index }}" tabindex="-1" aria-hidden="true">
                                            <div class="modal-dialog modal-xl modal-dialog-centered">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <h5 class="modal-title">–ú–µ–¥–∏–∞ —Ñ–∞–π–ª</h5>
                                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                    </div>
                                                    <div class="modal-body text-center">
                                                        <img src="{{ url_for('admin.serve_telegram_media', file_id=message.attachment_file_id) }}" class="img-fluid" alt="–ú–µ–¥–∏–∞">
                                                    </div>
                                                    <div class="modal-footer">
                                                        <a href="{{ url_for('admin.serve_telegram_media', file_id=message.attachment_file_id) }}" target="_blank" class="btn btn-primary" download>
                                                            <i class="fa-solid fa-download me-1"></i>–°–∫–∞—á–∞—Ç—å
                                                        </a>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% elif message.attachment_path %}
                                    <div class="mt-2">
                                        <a href="{{ url_for('admin.serve_upload', filename=message.attachment_path.split('/')[-1] if message.attachment_path else '') }}" target="_blank">
                                            <img src="{{ url_for('admin.serve_upload', filename=message.attachment_path.split('/')[-1] if message.attachment_path else '') }}" 
                                                 class="img-fluid rounded border" 
                                                 style="max-width: 300px; max-height: 200px; cursor: pointer;"
                                                 alt="–í–ª–æ–∂–µ–Ω–∏–µ">
                                        </a>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="text-muted small mt-1 {% if message.sender_type == 'admin' %}text-end{% endif %}">
                            <strong>
                                {% if message.sender_type == 'admin' %}–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä{% else %}{{ ticket.username or '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å' }}{% endif %}
                            </strong>
                            <span class="ms-2">{{ message.sent_at if message.sent_at else '' }}</span>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                <div class="text-center p-5">
                    <i class="fa-solid fa-comment-slash fa-3x text-light-emphasis"></i>
                    <h5 class="mt-3">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</h5>
                    <p class="text-muted">–ù–∞—á–Ω–∏—Ç–µ –¥–∏–∞–ª–æ–≥, –æ—Ç–ø—Ä–∞–≤–∏–≤ –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Response Form -->
        {% if ticket.status in ['open', 'in_progress'] %}
        <div class="card" x-data="{ responseText: '' }">
            <div class="card-header">
                <h5 class="mb-0"><i class="fa-solid fa-reply me-2"></i>–û—Ç–≤–µ—Ç–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('admin.update_ticket_status', ticket_id=ticket.id) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <input type="hidden" name="status" value="in_progress">
                    
                    <div class="mb-3">
                        <label class="form-label">–ë—ã—Å—Ç—Ä—ã–µ –æ—Ç–≤–µ—Ç—ã:</label>
                        <div class="row g-2">
                            <div class="col-sm-6">
                                <button type="button" @click="responseText = '–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ! –ú—ã —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–ª–∏ –≤–∞—à—É –ø—Ä–æ–±–ª–µ–º—É –∏ –≥–æ—Ç–æ–≤—ã –ø–æ–º–æ—á—å.'" class="btn btn-sm btn-outline-secondary w-100 text-start">üôè –ë–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å</button>
                            </div>
                            <div class="col-sm-6">
                                <button type="button" @click="responseText = '–î–ª—è —Ä–µ—à–µ–Ω–∏—è –≤–∞—à–µ–π –ø—Ä–æ–±–ª–µ–º—ã –Ω–∞–º –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤—å—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ:'" class="btn btn-sm btn-outline-secondary w-100 text-start">ü§î –ó–∞–ø—Ä–æ—Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏</button>
                            </div>
                            <div class="col-sm-6">
                                <button type="button" @click="responseText = '–í–∞—à–∞ –ø—Ä–æ–±–ª–µ–º–∞ —Ä–µ—à–µ–Ω–∞! –ï—Å–ª–∏ —É –≤–∞—Å –≤–æ–∑–Ω–∏–∫–Ω—É—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã, –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å.'" class="btn btn-sm btn-outline-secondary w-100 text-start">‚úÖ –ü—Ä–æ–±–ª–µ–º–∞ —Ä–µ—à–µ–Ω–∞</button>
                            </div>
                            <div class="col-sm-6">
                                <button type="button" @click="responseText = '–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –º—ã –Ω–µ –º–æ–∂–µ–º —Ä–µ—à–∏—Ç—å –≤–∞—à—É –ø—Ä–æ–±–ª–µ–º—É –≤ —Ä–∞–º–∫–∞—Ö –¥–∞–Ω–Ω–æ–≥–æ –æ–±—Ä–∞—â–µ–Ω–∏—è. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.'" class="btn btn-sm btn-outline-secondary w-100 text-start">üö® –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="response" class="form-label">–í–∞—à –æ—Ç–≤–µ—Ç</label>
                        <textarea id="response" name="response_message" rows="5" x-model="responseText" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é..." required></textarea>
                        <div class="form-text">–û—Ç–≤–µ—Ç –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤ Telegram.</div>
                    </div>
                    
                    <div class="d-flex justify-content-end">
                        <button type="submit" class="btn btn-primary">
                            <i class="fa-solid fa-paper-plane me-2"></i>–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç
                        </button>
                    </div>
                </form>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Ticket Info -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fa-solid fa-circle-info me-2"></i>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–∏–∫–µ—Ç–µ</h5>
            </div>
            <div class="card-body">
                <dl class="row mb-0">
                    <dt class="col-sm-4">–¢–µ–º–∞</dt>
                    <dd class="col-sm-8">{{ ticket.subject }}</dd>
                    <dt class="col-sm-4">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</dt>
                    <dd class="col-sm-8">{{ ticket.username or '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ' }}</dd>
                    {% if ticket.participant_name %}
                    <dt class="col-sm-4">–£—á–∞—Å—Ç–Ω–∏–∫</dt>
                    <dd class="col-sm-8"><a href="{{ url_for('admin.participant_detail', participant_id=ticket.participant_id) }}">{{ ticket.participant_name }}</a></dd>
                    {% endif %}
                    <dt class="col-sm-4">–°–æ–∑–¥–∞–Ω</dt>
                    <dd class="col-sm-8">{{ ticket.created_at|moscow_time if ticket.created_at else '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ' }}</dd>
                    <dt class="col-sm-4">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</dt>
                    <dd class="col-sm-8">
                        {% set category_map = {
                            'photo_problem': ('üì∑ –ü—Ä–æ–±–ª–µ–º—ã —Å —Ñ–æ—Ç–æ', 'badge-light-danger'),
                            'loyalty_card': ('üí≥ –ö–∞—Ä—Ç–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏', 'badge-light-info'),
                            'technical': ('üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ', 'badge-light-warning'),
                            'status': ('üìã –°—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏', 'badge-light-primary'),
                            'lottery': ('üé≤ –†–æ–∑—ã–≥—Ä—ã—à', 'badge-light-success'),
                            'other': ('‚ùì –î—Ä—É–≥–æ–µ', 'badge-light-secondary')
                        } %}
                        {% set cat_info = category_map.get(ticket.category, category_map['other']) %}
                        <span class="badge {{ cat_info[1] }}">{{ cat_info[0] }}</span>
                    </dd>
                </dl>
            </div>
        </div>

        <!-- Actions -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fa-solid fa-cogs me-2"></i>–î–µ–π—Å—Ç–≤–∏—è</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('admin.update_ticket_status', ticket_id=ticket.id) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <div class="d-grid gap-2">
                        <select name="status" class="form-select">
                            <option value="open" {% if ticket.status == 'open' %}selected{% endif %}>–û—Ç–∫—Ä—ã—Ç</option>
                            <option value="in_progress" {% if ticket.status == 'in_progress' %}selected{% endif %}>–í —Ä–∞–±–æ—Ç–µ</option>
                            <option value="resolved" {% if ticket.status == 'resolved' %}selected{% endif %}>–†–µ—à–µ–Ω</option>
                            <option value="closed" {% if ticket.status == 'closed' %}selected{% endif %}>–ó–∞–∫—Ä—ã—Ç</option>
                        </select>
                        <button type="submit" class="btn btn-secondary">
                            <i class="fa-solid fa-save me-2"></i>–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatContainer = document.getElementById('chat-container');
    if (chatContainer) {
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }
});
</script>
{% endblock %}