{% extends "base.html" %}

{% block title %}{{ participant.full_name }} - –£—á–∞—Å—Ç–Ω–∏–∫{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <div>
        <h1 class="h2">{{ participant.full_name }}</h1>
        <p class="text-muted">–î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —É—á–∞—Å—Ç–Ω–∏–∫–µ</p>
    </div>
    <a href="{{ url_for('admin.participants') }}" class="btn btn-sm btn-outline-secondary">
        <i class="fa-solid fa-arrow-left me-2"></i>–ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É
    </a>
</div>

<div class="row g-4">

    <!-- Main Content -->
    <div class="col-lg-8">
        <div class="d-flex flex-column gap-4">
            <!-- Participant Information -->
            <div class="card">
                <div class="card-header">
                    <i class="fa-solid fa-user-circle me-2"></i>
                    –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
                </div>
                <div class="card-body">
                    <dl class="row">
                        <dt class="col-sm-4">–ü–æ–ª–Ω–æ–µ –∏–º—è</dt>
                        <dd class="col-sm-8">{{ participant.full_name }}</dd>

                        <dt class="col-sm-4">–¢–µ–ª–µ—Ñ–æ–Ω</dt>
                        <dd class="col-sm-8">{{ participant.phone_number }}</dd>

                        <dt class="col-sm-4">Telegram</dt>
                        <dd class="col-sm-8">
                            {% if participant.username %}@{{ participant.username }}{% else %}-{% endif %}
                            <span class="text-muted small"> (ID: {{ participant.telegram_id }})</span>
                        </dd>

                        <dt class="col-sm-4">–ö–∞—Ä—Ç–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏</dt>
                        <dd class="col-sm-8">{{ participant.loyalty_card }}</dd>

                        <dt class="col-sm-4">–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</dt>
                        <dd class="col-sm-8">{{ participant.registration_date if participant.registration_date else 'N/A' }}</dd>

                        <dt class="col-sm-4">–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å</dt>
                        <dd class="col-sm-8">
                            {% if participant.status == 'approved' %}
                                <span class="badge badge-light-success">–û–¥–æ–±—Ä–µ–Ω–æ</span>
                            {% elif participant.status == 'pending' %}
                                <span class="badge badge-light-warning">–ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏</span>
                            {% elif participant.status == 'rejected' %}
                                <span class="badge badge-light-danger">–û—Ç–∫–ª–æ–Ω–µ–Ω–æ</span>
                            {% endif %}
                        </dd>

                        {% if participant.admin_notes %}
                        <dt class="col-sm-4">–ó–∞–º–µ—Ç–∫–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</dt>
                        <dd class="col-sm-8">
                            <div class="bg-light p-3 rounded border">{{ participant.admin_notes | replace('\n', '<br>') | safe }}</div>
                        </dd>
                        {% endif %}
                    </dl>
                </div>
            </div>

            <!-- Leaflet Photo -->
            {% if participant.photo_path %}
            <div class="card">
                <div class="card-header">
                    <i class="fa-solid fa-image me-2"></i>
                    –§–æ—Ç–æ –ª–∏—Ñ–ª–µ—Ç–∞
                </div>
                <div class="card-body text-center p-2">
                    <a href="#" data-bs-toggle="modal" data-bs-target="#photoModal">
                        <img src="{{ url_for('admin.serve_upload', filename=participant.photo_path.split('/')[-1] if participant.photo_path else '') }}" alt="–§–æ—Ç–æ –ª–∏—Ñ–ª–µ—Ç–∞" class="img-fluid rounded" style="max-height: 400px;">
                    </a>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Actions Panel -->
    <div class="col-lg-4">
        <div class="d-flex flex-column gap-4">
            <div class="card">
                <div class="card-header">
                    <i class="fa-solid fa-cogs me-2"></i>
                    –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–º
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('admin.update_single_participant_status', participant_id=participant.id) }}" id="statusForm">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <div class="mb-3">
                            <label for="status" class="form-label">–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å</label>
                            <select id="status" name="status" class="form-select">
                                <option value="pending" {% if participant.status == 'pending' %}selected{% endif %}>–ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏</option>
                                <option value="approved" {% if participant.status == 'approved' %}selected{% endif %}>–û–¥–æ–±—Ä–∏—Ç—å</option>
                                <option value="rejected" {% if participant.status == 'rejected' %}selected{% endif %}>–û—Ç–∫–ª–æ–Ω–∏—Ç—å</option>
                            </select>
                        </div>

                        <div id="rejectionTemplates" data-show="{% if participant.status == 'rejected' %}true{% else %}false{% endif %}">
                            <label class="form-label small">–®–∞–±–ª–æ–Ω—ã –ø—Ä–∏—á–∏–Ω –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è:</label>
                            <div class="d-grid gap-2 mb-3">
                                <button type="button" class="btn btn-sm btn-outline-secondary text-start" onclick="setNote('–ù–µ—á–µ—Ç–∫–æ–µ —Ñ–æ—Ç–æ –ª–∏—Ñ–ª–µ—Ç–∞.')">üì∑ –ù–µ—á–µ—Ç–∫–æ–µ —Ñ–æ—Ç–æ</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary text-start" onclick="setNote('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.')">üìù –ù–µ–∫–æ—Ä—Ä. –¥–∞–Ω–Ω—ã–µ</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary text-start" onclick="setNote('–ö–∞—Ä—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.')">üí≥ –ö–∞—Ä—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary text-start" onclick="setNote('–ù–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª.')">‚ö†Ô∏è –ù–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª</button>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="notes" class="form-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–ª—è —É—á–∞—Å—Ç–Ω–∏–∫–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                            <textarea id="notes" name="notes" rows="3" class="form-control" placeholder="–≠—Ç–æ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ Telegram...">{{ participant.admin_notes or '' }}</textarea>
                        </div>

                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" name="send_notification" id="send_notification" checked>
                            <label class="form-check-label" for="send_notification">
                                –û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤ Telegram
                            </label>
                        </div>

                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fa-solid fa-save me-2"></i>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                        </button>
                    </form>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <i class="fa-solid fa-bolt me-2"></i>
                    –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
                </div>
                <div class="card-body d-grid gap-2">
                    <a href="https://t.me/{{ participant.username }}" target="_blank" class="btn btn-outline-secondary" {% if not participant.username %}disabled{% endif %}>
                        <i class="fa-brands fa-telegram me-2"></i>–ù–∞–ø–∏—Å–∞—Ç—å –≤ Telegram
                    </a>
                    <button onclick="copyToClipboard('{{ participant.telegram_id }}', 'Telegram ID')" class="btn btn-outline-secondary">
                        <i class="fa-solid fa-copy me-2"></i>–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å Telegram ID
                    </button>
                    <button onclick="copyToClipboard('{{ participant.phone_number }}', '–¢–µ–ª–µ—Ñ–æ–Ω')" class="btn btn-outline-secondary">
                        <i class="fa-solid fa-copy me-2"></i>–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Photo Modal -->
<div class="modal fade" id="photoModal" tabindex="-1" aria-labelledby="photoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="photoModalLabel">–§–æ—Ç–æ –ª–∏—Ñ–ª–µ—Ç–∞: {{ participant.full_name }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <img src="{{ url_for('admin.serve_upload', filename=participant.photo_path.split('/')[-1] if participant.photo_path else '') }}" class="img-fluid rounded" alt="–õ–∏—Ñ–ª–µ—Ç">
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function copyToClipboard(text, entity) {
    navigator.clipboard.writeText(text).then(() => {
        notyf.success(`${entity} —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞`);
    }).catch(err => {
        notyf.error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å');
        console.error('Failed to copy: ', err);
    });
}

function setNote(text) {
    document.getElementById('notes').value = text;
}

document.addEventListener('DOMContentLoaded', function() {
    const statusSelect = document.getElementById('status');
    const rejectionTemplates = document.getElementById('rejectionTemplates');
    const statusForm = document.getElementById('statusForm');

    if(statusSelect && rejectionTemplates) {
        // Set initial visibility
        rejectionTemplates.style.display = rejectionTemplates.dataset.show === 'true' ? 'block' : 'none';
        
        statusSelect.addEventListener('change', function() {
            rejectionTemplates.style.display = this.value === 'rejected' ? 'block' : 'none';
        });
    }

    if(statusForm) {
        statusForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const sendNotificationCheckbox = document.getElementById('send_notification');
            const shouldSendNotification = sendNotificationCheckbox ? sendNotificationCheckbox.checked : false;
            
            let title = '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ';
            let body = `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è?`;

            if (shouldSendNotification) {
                body += `<br><small class="text-muted">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∏—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram.</small>`;
            }

            const confirmModal = document.getElementById('confirmationModal');
            if(confirmModal) {
                confirmModal.querySelector('.modal-title').textContent = title;
                confirmModal.querySelector('.modal-body-content').innerHTML = body;
                
                const confirmForm = confirmModal.querySelector('#confirmActionForm');
                if (confirmForm) {
                    confirmForm.action = statusForm.action;
                    confirmForm.onsubmit = (e) => {
                        e.preventDefault();
                        statusForm.submit();
                    };
                }

                new bootstrap.Modal(confirmModal).show();
            } else {
                statusForm.submit();
            }
        });
    }
});
</script>
{% endblock %}