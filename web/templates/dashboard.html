{% extends "base.html" %}

{% block title %}–ì–ª–∞–≤–Ω–∞—è - –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π{% endblock %}

{% block page_title %}–ì–ª–∞–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å{% endblock %}
{% block page_subtitle %}–û–±–∑–æ—Ä –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Å–∏—Å—Ç–µ–º—ã —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π –∏ –∫–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏{% endblock %}

{% block content %}

<!-- –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
<div class="card mb-6">
    <div class="card-header">
        <h2 class="card-title">–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h2>
    </div>
    <div class="card-body">
        <div class="quick-actions">
            <a href="{{ url_for('admin.lottery') }}" class="quick-action">
                <div class="quick-action-icon">
                    <i class="fas fa-dice"></i>
                </div>
                <div class="quick-action-content">
                    <h3>–ü—Ä–æ–≤–µ—Å—Ç–∏ —Ä–æ–∑—ã–≥—Ä—ã—à</h3>
                    <p>–ó–∞–ø—É—Å—Ç–∏—Ç—å –Ω–æ–≤—ã–π —Ä–æ–∑—ã–≥—Ä—ã—à —Å—Ä–µ–¥–∏ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</p>
                </div>
            </a>
                
            <a href="{{ url_for('admin.broadcasts') }}" class="quick-action">
                <div class="quick-action-icon">
                    <i class="fas fa-bullhorn"></i>
                </div>
                <div class="quick-action-content">
                    <h3>–ù–∞—á–∞—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É</h3>
                    <p>–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º</p>
                </div>
            </a>
            
            <a href="{{ url_for('admin.participants', status='pending') }}" class="quick-action">
                <div class="quick-action-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="quick-action-content">
                    <h3>–ù–æ–≤—ã–µ –∑–∞—è–≤–∫–∏</h3>
                    <p>–ú–æ–¥–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∑–∞—è–≤–∫–∏ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</p>
                    <span class="badge badge-notification">12</span>
                </div>
            </a>
            
            <a href="{{ url_for('admin.export_participants') }}" class="quick-action">
                <div class="quick-action-icon">
                    <i class="fas fa-download"></i>
                </div>
                <div class="quick-action-content">
                    <h3>–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</h3>
                    <p>–°–∫–∞—á–∞—Ç—å –æ—Ç—á–µ—Ç—ã –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫—É</p>
                </div>
            </a>
        </div>
    </div>
</div>

<!-- –ö–∞—Ä—Ç–æ—á–∫–∏ –º–µ—Ç—Ä–∏–∫ -->
<div class="card mb-6">
    <div class="card-header">
        <h2 class="card-title">–ö–∞—Ä—Ç–æ—á–∫–∏ –º–µ—Ç—Ä–∏–∫</h2>
    </div>
    <div class="card-body">
        <div class="grid grid-cols-4 gap-6">
            <!-- –í—Å–µ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ -->
            <div class="card metric-card hover-elevate">
                <div class="card-body">
                    <div class="metric-card-content">
                        <div class="metric-title">–í—Å–µ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</div>
                        <div class="metric-value">{{ stats.total_participants }}</div>
                        <div class="metric-subtitle">–ó–∞ –≤—Å–µ –≤—Ä–µ–º—è</div>
                    </div>
                    <i class="fas fa-users metric-icon"></i>
                </div>
            </div>

            <!-- –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å–µ–≥–æ–¥–Ω—è -->
            <div class="card metric-card hover-elevate">
                <div class="card-body">
                    <div class="metric-card-content">
                        <div class="metric-title">–û–¥–æ–±—Ä–µ–Ω–æ</div>
                        <div class="metric-value">{{ stats.by_status.get('approved', 0) }}</div>
                        <div class="metric-subtitle">–°—Ç–∞—Ç—É—Å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</div>
                    </div>
                    <i class="fas fa-chart-line metric-icon"></i>
                </div>
            </div>

            <!-- –û—Ç–∫—Ä—ã—Ç—ã–µ —Ç–∏–∫–µ—Ç—ã -->
            <div class="card metric-card hover-elevate">
                <div class="card-body">
                    <div class="metric-card-content">
                        <div class="metric-title">–û—Ç–∫—Ä—ã—Ç—ã–µ —Ç–∏–∫–µ—Ç—ã</div>
                        <div class="metric-value">{{ stats.open_tickets or 0 }}</div>
                        <div class="metric-subtitle">–¢—Ä–µ–±—É—é—Ç –≤–Ω–∏–º–∞–Ω–∏—è</div>
                    </div>
                    <i class="fas fa-headset metric-icon"></i>
                </div>
            </div>

            <!-- –¢–µ–∫—É—â–∏–π —Ä–æ–∑—ã–≥—Ä—ã—à -->
            <div class="card metric-card hover-elevate">
                <div class="card-body">
                    <div class="metric-card-content">
                        <div class="metric-title">–ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏</div>
                        <div class="metric-value">{{ stats.by_status.get('pending', 0) }}</div>
                        <div class="metric-subtitle">–°—Ç–∞—Ç—É—Å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</div>
                    </div>
                    <i class="fas fa-dice metric-icon"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –û–ø–µ—Ä–∞—Ç–∏–≤–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ —Å–µ—Ä–≤–∏—Å–æ–≤ -->
<div class="card mb-6">
    <div class="card-header">
        <h2 class="card-title">–û–ø–µ—Ä–∞—Ç–∏–≤–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏</h2>
    </div>
    <div class="card-body">
        <div class="grid grid-cols-3 gap-6">
            <div class="card metric-card hover-elevate">
                <div class="card-body">
                    <div class="metric-card-content">
                        <div class="metric-title">–¢–∏–∫–µ—Ç—ã –≤ —Ä–∞–±–æ—Ç–µ</div>
                        <div class="metric-value">{{ (stats.tickets_in_progress or 0) }}</div>
                        <div class="metric-subtitle">–ù–∞–∑–Ω–∞—á–µ–Ω—ã –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞–º</div>
                    </div>
                    <i class="fas fa-briefcase metric-icon"></i>
                </div>
            </div>
            <div class="card metric-card hover-elevate">
                <div class="card-body">
                    <div class="metric-card-content">
                        <div class="metric-title">–¢–∏–∫–µ—Ç—ã –∑–∞–∫—Ä—ã—Ç—ã</div>
                        <div class="metric-value">{{ (stats.tickets_closed or 0) }}</div>
                        <div class="metric-subtitle">–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –æ–±—Ä–∞—â–µ–Ω–∏—è</div>
                    </div>
                    <i class="fas fa-check metric-icon"></i>
                </div>
            </div>
            <div class="card metric-card hover-elevate">
                <div class="card-body">
                    <div class="metric-card-content">
                        <div class="metric-title">–ù–µ—É–¥–∞—á–Ω—ã—Ö —Ä–∞—Å—Å—ã–ª–æ–∫</div>
                        <div class="metric-value">{{ (stats.failed_broadcasts or 0) }}</div>
                        <div class="metric-subtitle">–¢—Ä–µ–±—É—é—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏</div>
                    </div>
                    <i class="fas fa-triangle-exclamation metric-icon"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –£–±—Ä–∞–Ω—ã —Å—Ç–∞—Ç—É—Å—ã –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –∑–∞–ø—Ä–æ—Å—É -->

<!-- –†–æ–∑—ã–≥—Ä—ã—à -->
    

<!-- –°–∏—Å—Ç–µ–º–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ -->
<div class="card mb-6">
    <div class="card-header">
        <h2 class="card-title">–°–∏—Å—Ç–µ–º–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏</h2>
    </div>
    <div class="card-body">
        {% if recent_tickets %}
            {% for ticket in recent_tickets %}
            <div class="support-ticket" style="margin-top: var(--space-4);">
                <div class="ticket-header">
                    <h3 class="ticket-title">{{ ticket.subject or ticket.title or '–ë–µ–∑ —Ç–µ–º—ã' }}</h3>
                    <div class="d-flex gap-2">
                        <span class="status-badge status-{{ ticket.status or 'open' }}">
                            {% if ticket.status == 'open' %}–û—Ç–∫—Ä—ã—Ç{% elif ticket.status == 'in_progress' %}–í —Ä–∞–±–æ—Ç–µ{% elif ticket.status == 'closed' %}–ó–∞–∫—Ä—ã—Ç{% else %}{{ ticket.status }}{% endif %}
                        </span>
                        <span class="status-badge status-archived">{{ ticket.category or '–û–±—â–∏–µ' }}</span>
                    </div>
                </div>
                <div class="ticket-content">
                    <p class="ticket-description">{{ ticket.message or ticket.description or '‚Äî' }}</p>
                    <div class="ticket-meta">
                        <span><i class="fas fa-user"></i> {{ ticket.participant_name or '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å' }}</span>
                        <span><i class="fas fa-clock"></i> {{ ticket.created_at or '' }}</span>
                    </div>
                    <div class="ticket-actions">
                        <a href="{{ url_for('admin.support_ticket_detail', ticket_id=ticket.id) }}" class="btn btn-sm btn-outline">üëÅÔ∏è –ü–æ–¥—Ä–æ–±–Ω–µ–µ</a>
                        <button class="btn btn-sm btn-success"
                                data-bs-toggle="modal"
                                data-bs-target="#confirmationModal"
                                data-bs-title="–ó–∞–∫—Ä—ã—Ç—å —Ç–∏–∫–µ—Ç?"
                                data-bs-body="–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–∫—Ä—ã—Ç—å —Ç–∏–∫–µ—Ç?"
                                data-bs-action="{{ url_for('admin.update_ticket_status', ticket_id=ticket.id) }}"
                                data-bs-fields='{"status":"closed"}'>–ó–∞–∫—Ä—ã—Ç—å</button>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="text-muted">–ù–µ—Ç –æ—Ç–∫—Ä—ã—Ç—ã—Ö —Ç–∏–∫–µ—Ç–æ–≤</div>
        {% endif %}
    </div>
</div>

<!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏ -->
<div class="card mb-6">
    <div class="card-header">
        <h2 class="card-title">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏</h2>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="data-table">
                <thead>
                    <tr>
                        <th style="width: 40px;">
                            <input type="checkbox" id="select-all" style="margin: 0;">
                        </th>
                        <th>–£—á–∞—Å—Ç–Ω–∏–∫</th>
                        <th>–ö–æ–Ω—Ç–∞–∫—Ç—ã</th>
                        <th>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–§–æ—Ç–æ</th>
                        <th style="width: 100px;">–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody>
                    {% for p in recent_participants %}
                    <tr>
                        <td>
                            <input type="checkbox" class="row-select" style="margin: 0;" value="{{ p.id }}">
                        </td>
                        <td>
                            <div>
                                <div style="font-weight: 600;">{{ p.full_name }}</div>
                                {% if p.loyalty_card %}
                                <div class="text-mono" style="font-size: 12px; color: var(--color-gray-500);">
                                    –ö–∞—Ä—Ç–∞: {{ p.loyalty_card }}
                                </div>
                                {% endif %}
                            </div>
                        </td>
                        <td>
                            <div style="font-size: 12px;">
                                <div>{{ p.phone_number }}</div>
                                {% if p.username %}<div style="color: var(--color-primary);">@{{ p.username }}</div>{% endif %}
                            </div>
                        </td>
                        <td>
                            <div style="font-size: 13px;">{{ p.registration_date }}</div>
                        </td>
                        <td>
                            <span class="status-badge status-{{ p.status }}">
                                {% if p.status == 'pending' %}–û–∂–∏–¥–∞–µ—Ç{% elif p.status == 'approved' %}–û–¥–æ–±—Ä–µ–Ω–æ{% elif p.status == 'rejected' %}–û—Ç–∫–ª–æ–Ω–µ–Ω–æ{% else %}{{ p.status }}{% endif %}
                            </span>
                        </td>
                        <td>
                            <span class="status-badge {% if p.photo_path %}status-approved{% else %}status-archived{% endif %}" style="font-size: 11px;">
                                {% if p.photo_path %}–ï—Å—Ç—å{% else %}–ù–µ—Ç{% endif %}
                            </span>
                        </td>
                        <td>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline" type="button" data-bs-toggle="dropdown">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="{{ url_for('admin.participant_detail', participant_id=p.id) }}">üëÅÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä</a></li>
                                    {% if p.status == 'pending' %}
                                    <li><a class="dropdown-item text-success" href="#" data-bs-toggle="modal" data-bs-target="#confirmationModal" data-bs-title="–û–¥–æ–±—Ä–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞?" data-bs-body="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –æ–¥–æ–±—Ä–µ–Ω–∏–µ –∑–∞—è–≤–∫–∏?" data-bs-action="{{ url_for('admin.update_single_participant_status', participant_id=p.id) }}" data-bs-fields='{"status":"approved"}'>‚úÖ –û–¥–æ–±—Ä–∏—Ç—å</a></li>
                                    <li><a class="dropdown-item text-danger" href="#" data-bs-toggle="modal" data-bs-target="#confirmationModal" data-bs-title="–û—Ç–∫–ª–æ–Ω–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞?" data-bs-body="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –∑–∞—è–≤–∫–∏?" data-bs-action="{{ url_for('admin.update_single_participant_status', participant_id=p.id) }}" data-bs-fields='{"status":"rejected"}'>‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å</a></li>
                                    {% endif %}
                                </ul>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- –ú–∞—Å—Å–æ–≤—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
        <div id="bulk-actions" style="display: none; background: var(--color-primary); color: white; padding: var(--space-3); border-top: 1px solid var(--color-gray-200);">
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <span id="selected-count">–í—ã–±—Ä–∞–Ω–æ: 0</span>
                <div>
                    <button class="btn btn-success btn-sm">‚úÖ –û–¥–æ–±—Ä–∏—Ç—å</button>
                    <button class="btn btn-danger btn-sm" style="margin-left: var(--space-2);">‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–≤ –∏ –ø—Ä–∏—á–∏–Ω—ã –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–π -->
<div class="grid grid-cols-2 gap-6">
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–≤</h2>
        </div>
        <div class="card-body">
            <div style="display: flex; flex-direction: column; gap: var(--space-3);">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>üéØ –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ —Å–µ–≥–æ–¥–Ω—è:</span>
                    <strong>{{ moderation.processed_today or 0 }}</strong>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>‚úÖ –û–¥–æ–±—Ä–µ–Ω–æ —Å–µ–≥–æ–¥–Ω—è:</span>
                    <strong>{{ moderation.approved_today or 0 }}</strong>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω–æ —Å–µ–≥–æ–¥–Ω—è:</span>
                    <strong>{{ moderation.rejected_today or 0 }}</strong>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h2 class="card-title">–¢–æ–ø –ø—Ä–∏—á–∏–Ω –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è</h2>
        </div>
        <div class="card-body">
            {% if top_reasons %}
            <div style="display: flex; flex-direction: column; gap: var(--space-2);">
                {% for r in top_reasons %}
                <div style="display: flex; justify-content: space-between;">
                    <span>{{ r['reason'] }}</span>
                    <strong>{{ r['cnt'] }}</strong>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –ø—Ä–∏—á–∏–Ω–∞–º</div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // –ú–∞—Å—Å–æ–≤—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –≤ —Ç–∞–±–ª–∏—Ü–µ
    const selectAllCheckbox = document.getElementById('select-all');
    const rowSelects = document.querySelectorAll('.row-select');
    const bulkActions = document.getElementById('bulk-actions');
    const selectedCount = document.getElementById('selected-count');

    function updateBulkActions() {
        const checkedRows = document.querySelectorAll('.row-select:checked');
        const count = checkedRows.length;
        
        if (count > 0) {
            bulkActions.style.display = 'block';
            selectedCount.textContent = `–í—ã–±—Ä–∞–Ω–æ: ${count}`;
        } else {
            bulkActions.style.display = 'none';
        }
    }

    selectAllCheckbox?.addEventListener('change', function() {
        rowSelects.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
        updateBulkActions();
    });

    rowSelects.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            updateBulkActions();
            
            // Update select all checkbox
            const totalRows = rowSelects.length;
            const checkedRows = document.querySelectorAll('.row-select:checked').length;
            
            if (selectAllCheckbox) {
                selectAllCheckbox.indeterminate = checkedRows > 0 && checkedRows < totalRows;
                selectAllCheckbox.checked = checkedRows === totalRows;
            }
        });
    });


    // Hover effects for metric cards
    document.querySelectorAll('.metric-card.hover-elevate').forEach(card => {
        card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-2px)';
            this.style.boxShadow = 'var(--shadow-lg)';
        });
        
        card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
            this.style.boxShadow = 'none';
        });
    });

    // Quick action hover effects
    document.querySelectorAll('.quick-action').forEach(action => {
        action.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-1px)';
            this.style.boxShadow = 'var(--shadow-md)';
        });
        
        action.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
            this.style.boxShadow = 'none';
        });
    });

    // Table row hover effects
    document.querySelectorAll('.data-table tbody tr').forEach(row => {
        row.addEventListener('mouseenter', function() {
            this.style.backgroundColor = 'var(--color-gray-50)';
        });
        
        row.addEventListener('mouseleave', function() {
            if (!this.classList.contains('selected')) {
                this.style.backgroundColor = 'transparent';
            }
        });
    });

    // Animate elements on page load
    const elements = document.querySelectorAll('.card, .quick-action, .metric-card');
    elements.forEach((element, index) => {
        element.style.opacity = '0';
        element.style.transform = 'translateY(20px)';
        
        setTimeout(() => {
            element.style.transition = 'all 0.3s ease';
            element.style.opacity = '1';
            element.style.transform = 'translateY(0)';
        }, index * 100);
    });
});
</script>
{% endblock %}