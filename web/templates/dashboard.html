{% extends "base.html" %}

{% block title %}Дашборд - Админ-панель{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Дашборд</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button type="button" class="btn btn-sm btn-outline-secondary">
                <i class="fa-solid fa-download me-1"></i>Экспорт
            </button>
        </div>
        <a href="{{ url_for('admin.participants', status='pending') }}" class="btn btn-sm btn-warning">
            <i class="fa-solid fa-clock me-1"></i>На рассмотрении
            {% if stats.by_status.get('pending', 0) > 0 %}
                <span class="badge bg-dark text-white ms-2">{{ stats.by_status.get('pending', 0) }}</span>
            {% endif %}
        </a>
    </div>
</div>

<!-- Stats -->
<div class="row">
    <div class="col-md-6 col-xl-3 mb-4">
        <div class="card h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-subtitle mb-2 text-muted">Всего участников</h6>
                        <h4 class="card-title mb-0">{{ stats.total_participants }}</h4>
                    </div>
                    <div class="fs-2 text-primary">
                        <i class="fa-solid fa-users"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6 col-xl-3 mb-4">
        <div class="card h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-subtitle mb-2 text-muted">Одобрено</h6>
                        <h4 class="card-title mb-0">{{ stats.by_status.get('approved', 0) }}</h4>
                    </div>
                    <div class="fs-2 text-success">
                        <i class="fa-solid fa-check-circle"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6 col-xl-3 mb-4">
        <div class="card h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-subtitle mb-2 text-muted">На рассмотрении</h6>
                        <h4 class="card-title mb-0">{{ stats.by_status.get('pending', 0) }}</h4>
                    </div>
                    <div class="fs-2 text-warning">
                        <i class="fa-solid fa-clock"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6 col-xl-3 mb-4">
        <div class="card h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-subtitle mb-2 text-muted">Победители</h6>
                        <h4 class="card-title mb-0">{{ stats.total_winners }}</h4>
                    </div>
                    <div class="fs-2 text-info">
                        <i class="fa-solid fa-trophy"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Participants and Status -->
<div class="row">
    <div class="col-lg-8 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Последние регистрации</h5>
            </div>
            <div class="card-body p-0">
                {% if recent_participants %}
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th scope="col">Имя</th>
                                <th scope="col">Статус</th>
                                <th scope="col">Дата</th>
                                <th scope="col" class="text-end">Действия</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for p in recent_participants %}
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div>
                                            <div class="fw-bold">{{ p.full_name }}</div>
                                            <div class="text-muted small">{{ p.phone_number }}</div>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    {% if p.status == 'approved' %}
                                        <span class="badge badge-light-success">Одобрено</span>
                                    {% elif p.status == 'pending' %}
                                        <span class="badge badge-light-warning">На рассмотрении</span>
                                    {% elif p.status == 'rejected' %}
                                        <span class="badge badge-light-danger">Отклонено</span>
                                    {% endif %}
                                </td>
                                <td class="text-muted small">{{ p.registration_date if p.registration_date else 'N/A' }}</td>
                                <td class="text-end">
                                    <a href="{{ url_for('admin.participant_detail', participant_id=p.id) }}" class="btn btn-sm btn-outline-secondary">Подробнее</a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="fa-solid fa-inbox fa-3x text-light-emphasis"></i>
                    <h5 class="mt-3">Нет недавних регистраций</h5>
                    <p class="text-muted">Новые участники будут отображаться здесь.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">Статистика по статусам</h5>
            </div>
            <div class="card-body">
                {% set total = stats.total_participants %}
                {% if total > 0 %}
                    <div class="">
                        {% for status, count in stats.by_status.items() %}
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-1 small">
                                <span>
                                {% if status == 'pending' %}На рассмотрении
                                {% elif status == 'approved' %}Одобрено
                                {% elif status == 'rejected' %}Отклонено
                                {% endif %}
                                </span>
                                <span>{{ count }} / {{ total }}</span>
                            </div>
                            <div class="progress" style="height: 8px;">
                                {% if total > 0 %}
                                    {% set progress_width = ((count / total) * 100) | round(0, 'floor') %}
                                {% else %}
                                    {% set progress_width = 0 %}
                                {% endif %}
                                <div class="progress-bar 
                                    {% if status == 'approved' %}bg-success
                                    {% elif status == 'pending' %}bg-warning
                                    {% elif status == 'rejected' %}bg-danger
                                    {% else %}bg-secondary
                                    {% endif %}"
                                    role="progressbar"
                                    data-width="{{ progress_width }}"
                                    aria-valuenow="{{ progress_width }}"
                                    aria-valuemin="0"
                                    aria-valuemax="100">
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fa-solid fa-chart-pie fa-3x text-light-emphasis"></i>
                    <h5 class="mt-3">Нет данных</h5>
                    <p class="text-muted">Статистика появится после регистрации участников.</p>
                </div>
                {% endif %}
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Быстрые действия</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ url_for('admin.participants') }}" class="btn btn-outline-secondary">
                        <i class="fa-solid fa-users me-2"></i>Все участники
                    </a>
                    <a href="{{ url_for('admin.settings') }}" class="btn btn-outline-secondary"><i class="fa-solid fa-gears me-2"></i>Настройки</a>
                    <a href="{{ url_for('admin.lottery') }}" class="btn btn-primary"><i class="fa-solid fa-play me-2"></i>Запустить розыгрыш</a>
                    <button type="button" class="btn btn-outline-danger"
                            data-bs-toggle="modal"
                            data-bs-target="#confirmationModal"
                            data-bs-title="Подтвердите действие"
                            data-bs-body="Вы уверены, что хотите очистить кеш? Это действие может повлиять на производительность."
                            data-bs-action="#">
                        <i class="fa-solid fa-trash-can me-2"></i>Очистить кеш
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Set progress bar widths from data attributes
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.progress-bar[data-width]').forEach(function(bar) {
        bar.style.width = bar.dataset.width + '%';
    });
});
</script>
{% endblock %}