<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π{% endblock %}</title>
    
    <!-- Preload fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    <!-- Main styles -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/custom.css') }}">
    
    {% block styles %}{% endblock %}
</head>
<body>
    <div class="admin-layout">
        <!-- –°–∞–π–¥–±–∞—Ä -->
        <aside class="sidebar" id="sidebar">
            <!-- Header —Å–∞–π–¥–±–∞—Ä–∞ -->
            <div class="sidebar-header">
                <h1 class="sidebar-title">üìä –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ</h1>
                <p class="sidebar-subtitle">–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–æ–∑—ã–≥—Ä—ã—à–∞–º–∏</p>
            </div>
            
            <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
            <nav class="nav-menu">
                <div class="nav-group">
                    <div class="nav-item">
                        <a href="{{ url_for('admin.dashboard') }}" 
                           class="nav-link {% if request.endpoint == 'admin.dashboard' %}active{% endif %}">
                            <i class="fas fa-chart-line"></i>
                            –ì–ª–∞–≤–Ω–∞—è
                        </a>
                    </div>
                    
                    <div class="nav-item">
                        <a href="#" class="nav-link expandable" id="participants-menu">
                            <i class="fas fa-users"></i>
                            –£—á–∞—Å—Ç–Ω–∏–∫–∏
                            <i class="fas fa-chevron-down"></i>
                            <span class="badge badge-notification">{{ global_stats.pending_participants if global_stats and global_stats.pending_participants is not none else 0 }}</span>
                        </a>
                        <div class="nav-submenu" id="participants-submenu">
                            <a href="{{ url_for('admin.participants', status='pending') }}" 
                               class="nav-link {% if request.endpoint == 'admin.participants' and request.args.get('status') == 'pending' %}active{% endif %}">
                                üë§‚ûï –ù–æ–≤—ã–µ –∑–∞—è–≤–∫–∏
                                <span class="badge badge-notification">{{ global_stats.pending_participants if global_stats and global_stats.pending_participants is not none else 0 }}</span>
                            </a>
                            <a href="{{ url_for('admin.participants') }}" 
                               class="nav-link {% if request.endpoint == 'admin.participants' and not request.args.get('status') %}active{% endif %}">
                                üë• –í—Å–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏
                            </a>
                        </div>
                    </div>
                    
                    <div class="nav-item">
                        <a href="#" class="nav-link expandable" id="lottery-menu">
                            <i class="fas fa-dice"></i>
                            –†–æ–∑—ã–≥—Ä—ã—à–∏
                            <i class="fas fa-chevron-down"></i>
                        </a>
                        <div class="nav-submenu" id="lottery-submenu">
                            <a href="{{ url_for('admin.lottery') }}" 
                               class="nav-link {% if request.endpoint == 'admin.lottery' %}active{% endif %}">
                                üé≤ –ü—Ä–æ–≤–µ—Å—Ç–∏
                            </a>
                            <a href="{{ url_for('admin.lottery') }}" 
                               class="nav-link">
                                üìú –ò—Å—Ç–æ—Ä–∏—è
                            </a>
                            <a href="{{ url_for('admin.winners') }}" 
                               class="nav-link">
                                üèÜ –ü–æ–±–µ–¥–∏—Ç–µ–ª–∏
                            </a>
                        </div>
                    </div>
                    
                    <div class="nav-item">
                        <a href="{{ url_for('admin.broadcasts') }}" 
                           class="nav-link {% if request.endpoint == 'admin.broadcasts' %}active{% endif %}">
                            <i class="fas fa-bullhorn"></i>
                            üì¢ –†–∞—Å—Å—ã–ª–∫–∏
                        </a>
                </div>
                    
                    <div class="nav-item">
                        <a href="{{ url_for('admin.support_tickets') }}" 
                           class="nav-link {% if 'support' in (request.endpoint or '') %}active{% endif %}">
                            <i class="fas fa-headset"></i>
                            üí¨ –ü–æ–¥–¥–µ—Ä–∂–∫–∞
                            <span class="badge badge-notification">{{ global_stats.open_tickets if global_stats and global_stats.open_tickets is not none else 0 }}</span>
                        </a>
                    </div>
                    
                    <div class="nav-item">
                        <a href="{{ url_for('admin.analytics') }}" 
                           class="nav-link {% if request.endpoint == 'admin.analytics' %}active{% endif %}">
                            <i class="fas fa-chart-bar"></i>
                            üìà –ê–Ω–∞–ª–∏—Ç–∏–∫–∞
                        </a>
                    </div>
                    
                    <div class="nav-item">
                        <a href="{{ url_for('admin.moderation') }}" 
                           class="nav-link {% if request.endpoint == 'admin.moderation' %}active{% endif %}">
                            <i class="fas fa-shield-alt"></i>
                            üõ°Ô∏è –ú–æ–¥–µ—Ä–∞—Ü–∏—è
                        </a>
                    </div>
                    
                    <div class="nav-item">
                        <a href="{{ url_for('admin.settings') }}" 
                           class="nav-link {% if request.endpoint == 'admin.settings' %}active{% endif %}">
                            <i class="fas fa-cog"></i>
                            ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏
                        </a>
                    </div>
                    
                    <div class="nav-item">
                        <a href="{{ url_for('admin.system_page') }}" 
                           class="nav-link {% if request.endpoint == 'admin.system_page' or request.endpoint == 'admin.view_log' %}active{% endif %}">
                            <i class="fas fa-server"></i>
                            üñ•Ô∏è –°–∏—Å—Ç–µ–º–∞
                        </a>
                    </div>
                        </div>
            </nav>
        </aside>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
        <main class="main-content">
            <!-- Header -->
            <header class="header">
                <div class="header-left">
                    <button class="sidebar-toggle" id="sidebar-toggle">
                        <i class="fas fa-bars"></i>
                        <span class="sr-only">Toggle Sidebar</span>
                    </button>
                    
                    <div>
                        <h1 class="page-title">{% block page_title %}–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π{% endblock %}</h1>
                        <p class="page-subtitle">{% block page_subtitle %}{% endblock %}</p>
                    </div>
                </div>
                
                <div class="header-actions">
                    <!-- –ü–æ–∏—Å–∫ -->
                    <div class="search-box position-relative">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" class="search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ —Å–∏—Å—Ç–µ–º–µ..." id="global-search" autocomplete="off">
                        <div id="search-dropdown" class="dropdown-menu show" style="display:none; position:absolute; top: 100%; left: 0; right: 0; max-height: 320px; overflow:auto;"></div>
            </div>
                    
                    <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
                    <div class="notifications dropdown">
                        <button class="notification-bell" id="notifications-btn" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-bell"></i>
                            <span class="notification-count">{{ global_stats.open_tickets if global_stats and global_stats.open_tickets is not none else 0 }}</span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" style="min-width: 280px;">
                            <li class="dropdown-header">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</li>
                            <li><a class="dropdown-item" href="{{ url_for('admin.support_tickets') }}">–û—Ç–∫—Ä—ã—Ç—ã—Ö —Ç–∏–∫–µ—Ç–æ–≤: {{ global_stats.open_tickets if global_stats and global_stats.open_tickets is not none else 0 }}</a></li>
                            <li><a class="dropdown-item" href="{{ url_for('admin.participants', status='pending') }}">–ù–æ–≤—ã–µ –∑–∞—è–≤–∫–∏: {{ global_stats.pending_participants if global_stats and global_stats.pending_participants is not none else 0 }}</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="{{ url_for('admin.lottery') }}">–†–æ–∑—ã–≥—Ä—ã—à</a></li>
                        </ul>
                    </div>
                    
                    <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ç–µ–º—ã -->
                    <button class="theme-toggle" id="theme-toggle" title="–¢–µ–º–∞">
                        <i class="fas fa-moon" id="theme-icon"></i>
                    </button>
                    
                    <!-- –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
                    <div class="user-profile" id="user-profile">
                        <div class="user-avatar">–ò–ü</div>
                        <div>
                            <p class="user-name">{{ current_user.username if current_user.is_authenticated else '–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤' }}</p>
                            <p class="user-role">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</p>
                        </div>
                    </div>
                </div>
            </header>
            
            <!-- –ö–æ–Ω—Ç–µ–Ω—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
            <div class="content">
                {% block content %}{% endblock %}
            </div>
        </main>
    </div>

    <!-- Mobile overlay -->
    <div class="sidebar-overlay" id="sidebar-overlay"></div>
    
    <!-- Flash messages container -->
    <div id="flash-messages" style="position: fixed; top: 80px; right: 20px; z-index: 9999;"></div>
    
    <!-- Confirmation Modal (global) -->
    <div class="modal fade" id="confirmationModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="modal-body-content">–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ?</div>
                </div>
                <div class="modal-footer">
                    <form id="confirmActionForm" method="POST">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <button type="button" class="btn btn-outline" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                        <button type="submit" class="btn btn-primary">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.js"></script>
    <script>window.CSRF_TOKEN = "{{ csrf_token() }}";</script>

    <!-- Flash messages data -->
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <script type="application/json" id="flash-messages-data">
    [
        {% for category, message in messages %}
        {
            "type": "{% if category == 'message' %}info{% else %}{{ category }}{% endif %}",
            "message": {{ message|tojson }}
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    ]
    </script>
    {% endif %}
    {% endwith %}

    <script>
    // Initialize notifications
        const notyf = new Notyf({
            duration: 5000,
        position: { x: 'right', y: 'top' },
            types: [
            { type: 'info', background: 'hsl(63, 69%, 45%)', icon: false },
            { type: 'success', background: 'hsl(142, 69%, 45%)', icon: false },
            { type: 'warning', background: 'hsl(45, 95%, 55%)', icon: false },
            { type: 'error', background: 'hsl(0, 84%, 60%)', icon: false }
            ]
        });

        // Flash messages handling
        document.addEventListener('DOMContentLoaded', function() {
            var flashMessagesElement = document.getElementById('flash-messages-data');
            if (flashMessagesElement) {
                var flashMessages = JSON.parse(flashMessagesElement.textContent);
                flashMessages.forEach(function(flash) {
                    notyf.open({ type: flash.type, message: flash.message });
                });
            }
        });

    // Sidebar functionality
    const sidebar = document.getElementById('sidebar');
    const sidebarToggle = document.getElementById('sidebar-toggle');
    const sidebarOverlay = document.getElementById('sidebar-overlay');

    sidebarToggle?.addEventListener('click', function() {
        sidebar?.classList.toggle('mobile-open');
        sidebarOverlay?.classList.toggle('active');
    });

    sidebarOverlay?.addEventListener('click', function() {
        sidebar?.classList.remove('mobile-open');
        sidebarOverlay?.classList.remove('active');
    });

    // Expandable menu functionality
    document.querySelectorAll('.nav-link.expandable').forEach(function(link) {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            
            const submenuId = this.id.replace('-menu', '-submenu');
            const submenu = document.getElementById(submenuId);
            
            if (submenu) {
                const isExpanded = submenu.classList.contains('expanded');
                
                // Close all other submenus
                document.querySelectorAll('.nav-submenu').forEach(function(menu) {
                    menu.classList.remove('expanded');
                });
                document.querySelectorAll('.nav-link.expandable').forEach(function(menuLink) {
                    menuLink.classList.remove('expanded');
                });
                
                // Toggle current submenu
                if (!isExpanded) {
                    submenu.classList.add('expanded');
                    this.classList.add('expanded');
                }
            }
        });
    });

    // Theme toggle
    const themeToggle = document.getElementById('theme-toggle');
    const themeIcon = document.getElementById('theme-icon');
    const savedTheme = localStorage.getItem('theme') || 'light';
    
    // Apply saved theme
    document.documentElement.setAttribute('data-theme', savedTheme);
    if (savedTheme === 'dark') {
        themeIcon?.classList.replace('fa-moon', 'fa-sun');
    }

    themeToggle?.addEventListener('click', function() {
        const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
        const newTheme = currentTheme === 'light' ? 'dark' : 'light';
        
        document.documentElement.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
        
        if (newTheme === 'dark') {
            themeIcon?.classList.replace('fa-moon', 'fa-sun');
        } else {
            themeIcon?.classList.replace('fa-sun', 'fa-moon');
        }
    });

    // Global search
    const globalSearch = document.getElementById('global-search');
    const searchDropdown = document.getElementById('search-dropdown');
    function highlight(text, q) {
        const i = text.toLowerCase().indexOf(q.toLowerCase());
        if (i === -1) return text;
        return text.substring(0,i) + '<mark>' + text.substring(i, i+q.length) + '</mark>' + text.substring(i+q.length);
    }
    let searchTimer;
    globalSearch?.addEventListener('input', async function(e){
        clearTimeout(searchTimer);
        const q = e.target.value.trim();
        if (q.length < 2) { searchDropdown.style.display='none'; return; }
        searchTimer = setTimeout(async () => {
            try {
                const res = await fetch(`/api/search?q=${encodeURIComponent(q)}`);
                const data = await res.json();
                const groups = data.results || {};
                let html = '';
                const renderGroup = (title, items) => {
                    if (!items || !items.length) return '';
                    let s = `<div class="dropdown-header">${title}</div>`;
                    items.forEach(item => {
                        const titleH = highlight(item.title || '', q);
                        const subH = item.subtitle ? ' <small class="text-muted">' + highlight(item.subtitle, q) + '</small>' : '';
                        s += `<a class="dropdown-item" href="${item.url}">${titleH}${subH}</a>`;
                    });
                    s += '<div class="dropdown-divider"></div>';
                    return s;
                };
                html += renderGroup('–£—á–∞—Å—Ç–Ω–∏–∫–∏', groups.participants);
                html += renderGroup('–¢–∏–∫–µ—Ç—ã', groups.tickets);
                html += renderGroup('–ü–æ–±–µ–¥–∏—Ç–µ–ª–∏', groups.winners);
                if (!html) html = '<div class="dropdown-item text-muted">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
                searchDropdown.innerHTML = html;
                searchDropdown.style.display = 'block';
            } catch(e) {
                searchDropdown.innerHTML = '<div class="dropdown-item text-danger">–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞</div>';
                searchDropdown.style.display = 'block';
            }
        }, 250);
    });
    globalSearch?.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            const query = e.target.value.trim();
            if (!query) return;
            const q = query.toLowerCase();
            if (q.includes('–ø–æ–±–µ–¥')) {
                window.location.href = "{{ url_for('admin.winners') }}";
            } else if (q.includes('—Ç–∏–∫–µ—Ç') || q.includes('–ø–æ–¥–¥–µ—Ä–∂')) {
                window.location.href = "{{ url_for('admin.support_tickets') }}";
            } else if (q.includes('—É—á–∞—Å—Ç')) {
                window.location.href = "{{ url_for('admin.participants') }}";
            } else if (q.includes('—Ä–æ–∑—ã') || q.includes('lottery')) {
                window.location.href = "{{ url_for('admin.lottery') }}";
            } else if (q.includes('—Ä–∞—Å—Å—ã–ª')) {
                window.location.href = "{{ url_for('admin.broadcasts') }}";
            } else {
                window.location.href = "{{ url_for('admin.dashboard') }}";
            }
        }
    });

    // Auto-expand active menu
    document.addEventListener('DOMContentLoaded', function() {
        const activeSubmenuLink = document.querySelector('.nav-submenu .nav-link.active');
        if (activeSubmenuLink) {
            const submenu = activeSubmenuLink.closest('.nav-submenu');
            const menuLink = submenu?.previousElementSibling;
            if (submenu && menuLink) {
                submenu.classList.add('expanded');
                menuLink.classList.add('expanded');
            }
        }
    });
    
    // Confirmation modal wiring
    const confirmationModal = document.getElementById('confirmationModal');
    if (confirmationModal) {
        confirmationModal.addEventListener('show.bs.modal', function (event) {
            const trigger = event.relatedTarget;
            if (!trigger) return;
            const title = trigger.getAttribute('data-bs-title') || '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ';
            const body = trigger.getAttribute('data-bs-body') || '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ?';
            const action = trigger.getAttribute('data-bs-action') || '#';
            const method = (trigger.getAttribute('data-bs-method') || 'POST').toUpperCase();
            
            const titleEl = confirmationModal.querySelector('.modal-title');
            const bodyEl = confirmationModal.querySelector('.modal-body-content');
            const formEl = confirmationModal.querySelector('#confirmActionForm');
            if (titleEl) titleEl.textContent = title;
            if (bodyEl) bodyEl.innerHTML = body;
            if (formEl) {
                formEl.action = action;
                formEl.method = method === 'GET' ? 'GET' : 'POST';
                // Remove previously added dynamic fields
                Array.from(formEl.querySelectorAll('[data-dynamic-field="1"]')).forEach(el => el.remove());
                // Add dynamic hidden fields if provided
                const fieldsJson = trigger.getAttribute('data-bs-fields');
                if (fieldsJson) {
                    try {
                        const fields = JSON.parse(fieldsJson);
                        Object.entries(fields).forEach(([key, value]) => {
                            const input = document.createElement('input');
                            input.type = 'hidden';
                            input.name = key;
                            input.value = value;
                            input.setAttribute('data-dynamic-field', '1');
                            formEl.appendChild(input);
                        });
                    } catch (e) {
                        console.warn('Invalid data-bs-fields JSON', e);
                    }
                }
            }
        });
    }
    </script>

    {% block scripts %}{% endblock %}
</body>
</html>