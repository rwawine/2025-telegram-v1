{% extends "base.html" %}

{% block title %}История розыгрышей{% endblock %}
{% block page_title %}История розыгрышей{% endblock %}
{% block page_subtitle %}Список прошедших розыгрышей{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2 class="card-title">Розыгрыши</h2>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Дата</th>
                        <th>Победителей</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody>
                    {% for r in runs %}
                    <tr>
                        <td>#{{ loop.index }}</td>
                        <td>{{ r.executed_at }}</td>
                        <td>{{ r.winners_count }}</td>
                        <td>
                            <a class="btn btn-sm btn-outline" href="{{ url_for('admin.winners_list', run_id=r.id) }}">Победители</a>
                            <a class="btn btn-sm btn-outline" href="{{ url_for('admin.export_winners', run_id=r.id) }}">Экспорт</a>
                            <button type="button" class="btn btn-sm btn-danger delete-lottery-btn" data-run-id="{{ r.id }}" data-executed-at="{{ r.executed_at }}">
                                <i class="fas fa-trash"></i> Удалить
                            </button>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="4" class="text-center text-muted">Розыгрыши не найдены</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.delete-lottery-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            const runId = this.dataset.runId;
            const executedAt = this.dataset.executedAt;
            
            if (confirm(`Вы уверены, что хотите удалить розыгрыш #${runId} от ${executedAt}?\n\nВНИМАНИЕ: Будут удалены ВСЕ победители этого розыгрыша!\n\nЭто действие необратимо.`)) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = `/admin/lottery/delete_run/${runId}`;
                
                const csrfToken = document.querySelector('meta[name="csrf-token"]');
                if (csrfToken) {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'csrf_token';
                    input.value = csrfToken.content;
                    form.appendChild(input);
                }
                
                document.body.appendChild(form);
                form.submit();
            }
        });
    });
});
</script>
{% endblock %}


