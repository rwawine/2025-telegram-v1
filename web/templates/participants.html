{% extends "base.html" %}

{% block title %}–£—á–∞—Å—Ç–Ω–∏–∫–∏ - –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å{% endblock %}
{% block page_title %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏{% endblock %}
{% block page_subtitle %}–ú–æ–¥–µ—Ä–∞—Ü–∏—è –∑–∞—è–≤–æ–∫ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞–º–∏ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤{% endblock %}

{% block content %}
<!-- –§–∏–ª—å—Ç—Ä—ã -->
<div class="card mb-6">
    <div class="card-header d-flex flex-wrap align-items-center justify-content-between gap-2">
        <h2 class="card-title mb-0">–§–∏–ª—å—Ç—Ä—ã –∏ –ø–æ–∏—Å–∫</h2>
        <div class="d-flex flex-wrap gap-2">
            <button type="button" class="btn btn-outline" data-bs-toggle="modal" data-bs-target="#importModal">‚¨ÜÔ∏è –ò–º–ø–æ—Ä—Ç</button>
            <a class="btn btn-outline" href="{{ url_for('admin.export_participants', status=current_status) }}">‚¨áÔ∏è –≠–∫—Å–ø–æ—Ä—Ç</a>
        </div>
    </div>
    <div class="card-body">
        <form method="GET" class="row g-3 align-items-end">
            <div class="col-12 col-md-6 col-lg-4">
                <label class="form-label">–ü–æ–∏—Å–∫</label>
                <input type="text" class="form-control" name="search" value="{{ search_query or '' }}" placeholder="–ò–º—è, —Ç–µ–ª–µ—Ñ–æ–Ω, email...">
            </div>
            <div class="col-6 col-md-3 col-lg-2">
                <label class="form-label">–°—Ç–∞—Ç—É—Å</label>
                <select name="status" class="form-control">
                    <option value="">–í—Å–µ</option>
                    <option value="pending" {% if current_status == 'pending' %}selected{% endif %}>–û–∂–∏–¥–∞–µ—Ç</option>
                    <option value="approved" {% if current_status == 'approved' %}selected{% endif %}>–û–¥–æ–±—Ä–µ–Ω–æ</option>
                    <option value="rejected" {% if current_status == 'rejected' %}selected{% endif %}>–û—Ç–∫–ª–æ–Ω–µ–Ω–æ</option>
                </select>
            </div>
            <div class="col-6 col-md-3 col-lg-2">
                <label class="form-label">–ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ</label>
                <select name="per_page" class="form-control">
                    <option value="25" {% if per_page==25 %}selected{% endif %}>25</option>
                    <option value="50" {% if per_page==50 %}selected{% endif %}>50</option>
                    <option value="100" {% if per_page==100 %}selected{% endif %}>100</option>
                </select>
            </div>
            <div class="col-12 col-md-12 col-lg-4 d-flex gap-2">
                <button type="submit" class="btn btn-primary flex-grow-1">üîç –ù–∞–π—Ç–∏</button>
            </div>
        </form>
    </div>
</div>

<!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
<div class="grid grid-cols-4 gap-4 mb-6">
    <div class="card metric-card hover-elevate">
        <div class="card-body">
            <div class="metric-title">–í—Å–µ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</div>
            <div class="metric-value">{{ total or 0 }}</div>
            <i class="fas fa-users metric-icon"></i>
        </div>
    </div>
    <div class="card metric-card hover-elevate">
        <div class="card-body">
            <div class="metric-title">–û–∂–∏–¥–∞—é—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏</div>
            <div class="metric-value">{{ (stats.by_status.get('pending', 0) if stats and stats.by_status else 0) }}</div>
            <i class="fas fa-clock metric-icon"></i>
        </div>
    </div>
    <div class="card metric-card hover-elevate">
        <div class="card-body">
            <div class="metric-title">–û–¥–æ–±—Ä–µ–Ω–æ</div>
            <div class="metric-value">{{ (stats.by_status.get('approved', 0) if stats and stats.by_status else 0) }}</div>
            <i class="fas fa-check-circle metric-icon"></i>
        </div>
    </div>
    <div class="card metric-card hover-elevate">
        <div class="card-body">
            <div class="metric-title">–û—Ç–∫–ª–æ–Ω–µ–Ω–æ</div>
            <div class="metric-value">{{ (stats.by_status.get('rejected', 0) if stats and stats.by_status else 0) }}</div>
            <i class="fas fa-times-circle metric-icon"></i>
        </div>
    </div>
</div>

<!-- –¢–∞–±–ª–∏—Ü–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">–°–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</h2>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <form id="massUpdateForm" method="POST" action="{{ url_for('admin.participants_mass_update') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <input type="hidden" name="next" value="{{ request.full_path }}"/>
                <input type="hidden" name="massParticipantIds" id="massParticipantIds" value=""/>
                <input type="hidden" name="status" id="massUpdateStatus" value=""/>
            </form>
            <table class="data-table">
                <thead>
                    <tr>
                        <th style="width: 40px;"><input type="checkbox" id="select-all"></th>
                        <th>–£—á–∞—Å—Ç–Ω–∏–∫</th>
                        <th>–ö–æ–Ω—Ç–∞–∫—Ç—ã</th>
                        <th>–î–∞—Ç–∞</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–§–æ—Ç–æ</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody>
                    {% for p in participants %}
                    <tr>
                        <td><input type="checkbox" class="row-select" value="{{ p.id }}"></td>
                        <td>
                            <div style="font-weight: 600;">{{ p.full_name or p.name or '–ù–µ —É–∫–∞–∑–∞–Ω–æ' }}</div>
                            {% if p.card_number %}
                            <div class="text-mono" style="font-size: 12px; color: var(--color-gray-500);">
                                –ö–∞—Ä—Ç–∞: {{ p.card_number }}
                            </div>
                            {% endif %}
                        </td>
                        <td>
                            <div style="font-size: 12px;">
                                {{ p.phone_number or p.phone }}<br>
                                {{ p.email }}<br>
                                <span style="color: var(--color-primary);">{{ p.telegram_id }}</span>
                            </div>
                        </td>
                        <td>{{ (p.registration_date or p.created_at)|moscow_time }}</td>
                        <td>
                            <span class="status-badge status-{{ p.status }}">
                                {% if p.status == 'pending' %}–û–∂–∏–¥–∞–µ—Ç
                                {% elif p.status == 'approved' %}–û–¥–æ–±—Ä–µ–Ω–æ
                                {% elif p.status == 'rejected' %}–û—Ç–∫–ª–æ–Ω–µ–Ω–æ
                                {% else %}{{ p.status }}{% endif %}
                            </span>
                        </td>
                        <td>
                            {% if p.photo_path %}
                                <div class="d-flex align-items-center">
                                    {% set photo_basename = p.photo_path.split('/')[-1].split('\\')[-1] %}
                                    <img src="{{ url_for('admin.serve_upload', filename=photo_basename) }}" 
                                         alt="–§–æ—Ç–æ" 
                                         class="photo-preview me-2" 
                                         style="width: 32px; height: 32px; object-fit: cover; border-radius: 4px; cursor: pointer;"
                                         data-photo-src="{{ url_for('admin.serve_upload', filename=photo_basename) }}"
                                         data-participant-name="{{ p.full_name or ('ID ' ~ p.id) }}"
                                         onclick="showPhotoModal(this)">
                                    <span class="status-badge status-approved" style="font-size: 11px;">–ï—Å—Ç—å</span>
                                </div>
                            {% else %}
                                <span class="status-badge status-archived" style="font-size: 11px;">–ù–µ—Ç</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline" data-bs-toggle="dropdown" data-bs-display="static" data-bs-boundary="viewport">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="{{ url_for('admin.participant_detail', participant_id=p.id) }}">üëÅÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä</a></li>
                                    {% if p.status == 'pending' %}
                                    <li><a class="dropdown-item text-success" href="#" data-bs-toggle="modal" data-bs-target="#confirmationModal" data-bs-title="–û–¥–æ–±—Ä–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞?" data-bs-body="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –æ–¥–æ–±—Ä–µ–Ω–∏–µ –∑–∞—è–≤–∫–∏?" data-bs-action="{{ url_for('admin.update_single_participant_status', participant_id=p.id) }}" data-bs-fields='{"status":"approved"}'>‚úÖ –û–¥–æ–±—Ä–∏—Ç—å</a></li>
                                    <li><a class="dropdown-item text-danger" href="#" data-bs-toggle="modal" data-bs-target="#confirmationModal" data-bs-title="–û—Ç–∫–ª–æ–Ω–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞?" data-bs-body="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –∑–∞—è–≤–∫–∏?" data-bs-action="{{ url_for('admin.update_single_participant_status', participant_id=p.id) }}" data-bs-fields='{"status":"rejected"}'>‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å</a></li>
                                    {% endif %}
                                    <li><a class="dropdown-item text-danger" href="#" data-bs-toggle="modal" data-bs-target="#confirmationModal" data-bs-title="–£–¥–∞–ª–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞?" data-bs-body="–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å." data-bs-action="{{ url_for('admin.delete_participant', participant_id=p.id) }}">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</a></li>
                                </ul>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" class="text-center text-muted">–ù–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º —É—Å–ª–æ–≤–∏—è–º</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- –ú–∞—Å—Å–æ–≤—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
        <div id="bulk-actions" style="display: none; background: var(--color-primary); color: white; padding: var(--space-3);">
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <span id="selected-count">–í—ã–±—Ä–∞–Ω–æ: 0</span>
                <div>
                    <button class="btn btn-success btn-sm" id="bulk-approve">‚úÖ –û–¥–æ–±—Ä–∏—Ç—å</button>
                    <button class="btn btn-danger btn-sm" id="bulk-reject">‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
                    <button class="btn btn-danger btn-sm" id="bulk-delete" 
                            data-bs-toggle="modal" 
                            data-bs-target="#confirmationModal"
                            data-bs-title="–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤?"
                            data-bs-body="–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å. –ë—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –≤—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ."
                            data-bs-action="{{ url_for('admin.delete_selected_participants') }}"
                            data-bs-confirm-word="—É–¥–∞–ª–∏—Ç—å">
                        üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // –ú–∞—Å—Å–æ–≤—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
    const selectAllCheckbox = document.getElementById('select-all');
    const rowSelects = document.querySelectorAll('.row-select');
    const bulkActions = document.getElementById('bulk-actions');
    const selectedCount = document.getElementById('selected-count');

    function updateBulkActions() {
        const checkedRows = document.querySelectorAll('.row-select:checked');
        const count = checkedRows.length;
        
        if (count > 0) {
            bulkActions.style.display = 'block';
            selectedCount.textContent = `–í—ã–±—Ä–∞–Ω–æ: ${count}`;
        } else {
            bulkActions.style.display = 'none';
        }
    }

    selectAllCheckbox?.addEventListener('change', function() {
        rowSelects.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
        updateBulkActions();
    });

    rowSelects.forEach(checkbox => {
        checkbox.addEventListener('change', updateBulkActions);
    });

    function openMassAction(status) {
        const ids = Array.from(document.querySelectorAll('.row-select:checked')).map(cb => cb.value);
        if (ids.length === 0) return;
        document.getElementById('massParticipantIds').value = ids.join(',');
        const trigger = document.createElement('button');
        trigger.setAttribute('data-bs-toggle', 'modal');
        trigger.setAttribute('data-bs-target', '#confirmationModal');
        trigger.setAttribute('data-bs-title', status === 'approved' ? '–û–¥–æ–±—Ä–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö?' : '–û—Ç–∫–ª–æ–Ω–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö?');
        trigger.setAttribute('data-bs-body', `–ë—É–¥–µ—Ç –∏–∑–º–µ–Ω–µ–Ω —Å—Ç–∞—Ç—É—Å —É ${ids.length} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤.`);
        trigger.setAttribute('data-bs-action', document.getElementById('massUpdateForm').action);
        trigger.setAttribute('data-bs-fields', JSON.stringify({ status }));
        document.body.appendChild(trigger);
        trigger.click();
        setTimeout(() => trigger.remove(), 0);
        const confirmForm = document.getElementById('confirmActionForm');
        if (confirmForm) {
            confirmForm.onsubmit = (e) => {
                e.preventDefault();
                document.getElementById('massUpdateStatus').value = status;
                document.getElementById('massUpdateForm').submit();
            };
        }
    }

    document.getElementById('bulk-approve')?.addEventListener('click', function(e) {
        e.preventDefault();
        openMassAction('approved');
    });
    document.getElementById('bulk-reject')?.addEventListener('click', function(e) {
        e.preventDefault();
        openMassAction('rejected');
    });

    document.getElementById('bulk-delete')?.addEventListener('click', function(e) {
        const ids = Array.from(document.querySelectorAll('.row-select:checked')).map(cb => cb.value);
        if (ids.length === 0) {
            e.preventDefault();
            alert('–í—ã–±–µ—Ä–∏—Ç–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è');
            return;
        }
        
        // Update modal with participant count and action
        const modal = document.getElementById('confirmationModal');
        if (modal) {
            const form = modal.querySelector('#confirmActionForm');
            if (form) {
                // Clear previous dynamic fields
                Array.from(form.querySelectorAll('[data-dynamic-field="1"]')).forEach(el => el.remove());
                
                // Add participant IDs as hidden field
                const idsInput = document.createElement('input');
                idsInput.type = 'hidden';
                idsInput.name = 'participant_ids';
                idsInput.value = ids.join(',');
                idsInput.setAttribute('data-dynamic-field', '1');
                form.appendChild(idsInput);
                
                // Update modal body with count
                const bodyEl = modal.querySelector('.modal-body-content');
                if (bodyEl) {
                    bodyEl.innerHTML = `–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å. –ë—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã ${ids.length} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∏ –≤—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.`;
                }
            }
        }
    });

    // Hover —ç—Ñ—Ñ–µ–∫—Ç—ã –¥–ª—è –º–µ—Ç—Ä–∏–∫
    document.querySelectorAll('.metric-card.hover-elevate').forEach(card => {
        card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-2px)';
            this.style.boxShadow = 'var(--shadow-lg)';
        });
        
        card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
            this.style.boxShadow = 'none';
        });
    });

    // Clear All confirmation
    const confirmWordInput = document.getElementById('confirmWord');
    const confirmClearAllButton = document.getElementById('confirmClearAll');
    
    if (confirmWordInput && confirmClearAllButton) {
        confirmWordInput.addEventListener('input', function() {
            const isValid = this.value.trim().toLowerCase() === '—É–¥–∞–ª–∏—Ç—å';
            confirmClearAllButton.disabled = !isValid;
            
            if (isValid) {
                confirmClearAllButton.classList.remove('btn-secondary');
                confirmClearAllButton.classList.add('btn-danger');
            } else {
                confirmClearAllButton.classList.remove('btn-danger');
                confirmClearAllButton.classList.add('btn-secondary');
            }
        });
        
        // Clear All Modal —É–¥–∞–ª—ë–Ω
    }

    // Photo modal function
    window.showPhotoModal = function(img) {
        const modalImg = document.getElementById('modalPhotoImg');
        const modalTitle = document.getElementById('photoModalLabel');
        const participantName = img.getAttribute('data-participant-name') || '–£—á–∞—Å—Ç–Ω–∏–∫';
        const photoSrc = img.getAttribute('data-photo-src') || img.src;
        
        if (modalImg && img) {
            modalImg.src = photoSrc;
            modalImg.alt = `–§–æ—Ç–æ ${participantName}`;
            // Store photo src for opening in new tab
            modalImg.setAttribute('data-full-src', photoSrc);
        }
        
        if (modalTitle) {
            modalTitle.textContent = `–§–æ—Ç–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞: ${participantName}`;
        }
        
        // Manually show modal to avoid Bootstrap issues
        const modal = document.getElementById('photoModal');
        if (modal && typeof bootstrap !== 'undefined' && bootstrap.Modal) {
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
        } else if (modal) {
            // Fallback for older Bootstrap versions
            modal.style.display = 'block';
            modal.classList.add('show');
            document.body.classList.add('modal-open');
            
            // Add backdrop
            const backdrop = document.createElement('div');
            backdrop.className = 'modal-backdrop fade show';
            backdrop.id = 'photoModalBackdrop';
            document.body.appendChild(backdrop);
        }
    };
    
    // Open photo in new tab
    window.openPhotoInNewTab = function() {
        const modalImg = document.getElementById('modalPhotoImg');
        if (modalImg && modalImg.getAttribute('data-full-src')) {
            window.open(modalImg.getAttribute('data-full-src'), '_blank');
        }
    };
    
    // Close photo modal manually
    window.closePhotoModal = function() {
        const modal = document.getElementById('photoModal');
        const backdrop = document.getElementById('photoModalBackdrop');
        
        if (modal) {
            modal.style.display = 'none';
            modal.classList.remove('show');
            document.body.classList.remove('modal-open');
        }
        
        if (backdrop) {
            backdrop.remove();
        }
    };
    
    // Add event listeners for modal close
    document.addEventListener('DOMContentLoaded', function() {
        const modal = document.getElementById('photoModal');
        if (modal) {
            // Close on backdrop click
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closePhotoModal();
                }
            });
            
            // Close on escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && modal.classList.contains('show')) {
                    closePhotoModal();
                }
            });
        }
    });

    // Ensure dropdown menus in tables overlay the table (portal to body)
    (function setupTableDropdownPortals() {
        const dropdowns = document.querySelectorAll('.data-table .dropdown');
        dropdowns.forEach(dd => {
            const toggle = dd.querySelector('[data-bs-toggle="dropdown"]');
            if (!toggle) return;

            dd.addEventListener('show.bs.dropdown', function() {
                const menu = dd.querySelector('.dropdown-menu');
                if (!menu) return;

                // Create placeholder to restore original position
                const placeholder = document.createElement('span');
                placeholder.style.display = 'none';
                placeholder.setAttribute('data-dropdown-placeholder', '1');
                menu._placeholder = placeholder;
                menu._owner = dd;
                menu.parentElement.insertBefore(placeholder, menu);

                // Move menu to body and position it near the toggle
                document.body.appendChild(menu);
                menu.setAttribute('data-portal', '1');
                menu.style.position = 'fixed';
                menu.style.display = 'block';
                menu.style.zIndex = '1080';
                menu.style.transform = 'none';

                const position = () => {
                    const rect = toggle.getBoundingClientRect();
                    // Calculate preferred left based on alignment
                    let left = rect.left;
                    // If right aligned
                    if (menu.classList.contains('dropdown-menu-end')) {
                        left = rect.right - menu.offsetWidth;
                    }
                    // Clamp to viewport
                    const vw = document.documentElement.clientWidth;
                    if (left + menu.offsetWidth > vw - 8) left = vw - menu.offsetWidth - 8;
                    if (left < 8) left = 8;

                    // Vertical position: prefer below, fallback above if not enough space
                    let top = rect.bottom + 2;
                    const vh = document.documentElement.clientHeight;
                    if (top + menu.offsetHeight > vh - 8) {
                        top = Math.max(8, rect.top - menu.offsetHeight - 2);
                    }

                    menu.style.left = left + 'px';
                    menu.style.top = top + 'px';
                };

                // Store and bind reposition handlers
                menu._reposition = position;
                position();
                window.addEventListener('scroll', position, true);
                window.addEventListener('resize', position);

                // Keep reference on owner for hide
                dd._currentMenu = menu;
            });

            dd.addEventListener('hide.bs.dropdown', function() {
                const menu = dd._currentMenu || dd.querySelector('.dropdown-menu');
                if (!menu) return;

                // Unbind listeners
                if (menu._reposition) {
                    window.removeEventListener('scroll', menu._reposition, true);
                    window.removeEventListener('resize', menu._reposition);
                }

                // Restore to original place
                if (menu._placeholder && menu._placeholder.parentNode) {
                    menu.removeAttribute('data-portal');
                    menu.style.position = '';
                    menu.style.display = '';
                    menu.style.left = '';
                    menu.style.top = '';
                    menu.style.transform = '';
                    menu.style.zIndex = '';
                    menu._placeholder.parentNode.insertBefore(menu, menu._placeholder);
                    menu._placeholder.parentNode.removeChild(menu._placeholder);
                }

                dd._currentMenu = null;
            });
        });
    })();
});
</script>
{% endblock %}

<!-- Import Modal -->
<div class="modal fade" id="importModal" tabindex="-1" aria-labelledby="importModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('admin.import_participants') }}" enctype="multipart/form-data">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <div class="modal-header">
                    <h5 class="modal-title" id="importModalLabel">–ò–º–ø–æ—Ä—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (CSV)</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="csvFile" class="form-label">CSV —Ñ–∞–π–ª</label>
                        <input type="file" class="form-control" id="csvFile" name="file" accept=".csv" required>
                        <div class="form-text">–ü–æ–ª—è: telegram_id, username, full_name, phone_number, loyalty_card, photo_path</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-primary">–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Clear All Modal —É–¥–∞–ª—ë–Ω –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é -->

<!-- Photo Modal -->
<div class="modal fade" id="photoModal" tabindex="-1" aria-labelledby="photoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="photoModalLabel">–§–æ—Ç–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞</h5>
                <button type="button" class="btn-close" onclick="closePhotoModal()" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <img id="modalPhotoImg" src="" alt="–§–æ—Ç–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞" class="img-fluid rounded shadow" style="max-height: 70vh; max-width: 100%;">
                <div class="mt-3">
                    <button type="button" class="btn btn-outline-primary" onclick="openPhotoInNewTab()">
                        <i class="fas fa-external-link-alt me-1"></i>–û—Ç–∫—Ä—ã—Ç—å –≤ –ø–æ–ª–Ω–æ–º —Ä–∞–∑–º–µ—Ä–µ
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>