{% extends "base.html" %}

{% block title %}–£—á–∞—Å—Ç–Ω–∏–∫–∏ - –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å{% endblock %}
{% block page_title %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏{% endblock %}
{% block page_subtitle %}–ú–æ–¥–µ—Ä–∞—Ü–∏—è –∑–∞—è–≤–æ–∫ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞–º–∏ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤{% endblock %}

{% block content %}
<!-- –§–∏–ª—å—Ç—Ä—ã -->
<div class="card mb-6">
    <div class="card-header">
        <h2 class="card-title">–§–∏–ª—å—Ç—Ä—ã –∏ –ø–æ–∏—Å–∫</h2>
    </div>
    <div class="card-body">
        <form method="GET" class="grid grid-cols-4 gap-4">
            <div class="form-group">
                <label class="form-label">–ü–æ–∏—Å–∫</label>
                <input type="text" class="form-control" name="search" 
                       value="{{ search_query or '' }}" placeholder="–ò–º—è, —Ç–µ–ª–µ—Ñ–æ–Ω, email...">
            </div>
            <div class="form-group">
                <label class="form-label">–°—Ç–∞—Ç—É—Å</label>
                <select name="status" class="form-control">
                    <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                    <option value="pending" {% if current_status == 'pending' %}selected{% endif %}>–û–∂–∏–¥–∞–µ—Ç</option>
                    <option value="approved" {% if current_status == 'approved' %}selected{% endif %}>–û–¥–æ–±—Ä–µ–Ω–æ</option>
                    <option value="rejected" {% if current_status == 'rejected' %}selected{% endif %}>–û—Ç–∫–ª–æ–Ω–µ–Ω–æ</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">–ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ</label>
                <select name="per_page" class="form-control">
                    <option value="25">25</option>
                    <option value="50" selected>50</option>
                    <option value="100">100</option>
                </select>
            </div>
            <div class="form-group d-flex align-items-end">
                <button type="submit" class="btn btn-primary">üîç –ù–∞–π—Ç–∏</button>
                <button type="button" class="btn btn-outline ms-2" data-bs-toggle="modal" data-bs-target="#importModal">‚¨ÜÔ∏è –ò–º–ø–æ—Ä—Ç</button>
                <a class="btn btn-outline ms-2" href="{{ url_for('admin.export_participants', status=current_status) }}">‚¨áÔ∏è –≠–∫—Å–ø–æ—Ä—Ç</a>
            </div>
        </form>
    </div>
</div>

<!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
<div class="grid grid-cols-4 gap-4 mb-6">
    <div class="card metric-card hover-elevate">
        <div class="card-body">
            <div class="metric-title">–í—Å–µ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</div>
            <div class="metric-value">{{ total or 0 }}</div>
            <i class="fas fa-users metric-icon"></i>
        </div>
    </div>
    <div class="card metric-card hover-elevate">
        <div class="card-body">
            <div class="metric-title">–û–∂–∏–¥–∞—é—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏</div>
            <div class="metric-value">{{ (stats.by_status.get('pending', 0) if stats and stats.by_status else 0) }}</div>
            <i class="fas fa-clock metric-icon"></i>
        </div>
    </div>
    <div class="card metric-card hover-elevate">
        <div class="card-body">
            <div class="metric-title">–û–¥–æ–±—Ä–µ–Ω–æ</div>
            <div class="metric-value">{{ (stats.by_status.get('approved', 0) if stats and stats.by_status else 0) }}</div>
            <i class="fas fa-check-circle metric-icon"></i>
        </div>
    </div>
    <div class="card metric-card hover-elevate">
        <div class="card-body">
            <div class="metric-title">–û—Ç–∫–ª–æ–Ω–µ–Ω–æ</div>
            <div class="metric-value">{{ (stats.by_status.get('rejected', 0) if stats and stats.by_status else 0) }}</div>
            <i class="fas fa-times-circle metric-icon"></i>
        </div>
    </div>
</div>

<!-- –¢–∞–±–ª–∏—Ü–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">–°–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</h2>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <form id="massUpdateForm" method="POST" action="{{ url_for('admin.participants_mass_update') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <input type="hidden" name="next" value="{{ request.full_path }}"/>
                <input type="hidden" name="massParticipantIds" id="massParticipantIds" value=""/>
                <input type="hidden" name="status" id="massUpdateStatus" value=""/>
            </form>
            <table class="data-table">
                <thead>
                    <tr>
                        <th style="width: 40px;"><input type="checkbox" id="select-all"></th>
                        <th>–£—á–∞—Å—Ç–Ω–∏–∫</th>
                        <th>–ö–æ–Ω—Ç–∞–∫—Ç—ã</th>
                        <th>–î–∞—Ç–∞</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–§–æ—Ç–æ</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody>
                    {% for p in participants %}
                    <tr>
                        <td><input type="checkbox" class="row-select" value="{{ p.id }}"></td>
                        <td>
                            <div style="font-weight: 600;">{{ p.full_name or p.name or '–ù–µ —É–∫–∞–∑–∞–Ω–æ' }}</div>
                            {% if p.card_number %}
                            <div class="text-mono" style="font-size: 12px; color: var(--color-gray-500);">
                                –ö–∞—Ä—Ç–∞: {{ p.card_number }}
                            </div>
                            {% endif %}
                        </td>
                        <td>
                            <div style="font-size: 12px;">
                                {{ p.phone_number or p.phone }}<br>
                                {{ p.email }}<br>
                                <span style="color: var(--color-primary);">{{ p.telegram_id }}</span>
                            </div>
                        </td>
                        <td>{{ p.registration_date or p.created_at }}</td>
                        <td>
                            <span class="status-badge status-{{ p.status }}">
                                {% if p.status == 'pending' %}–û–∂–∏–¥–∞–µ—Ç
                                {% elif p.status == 'approved' %}–û–¥–æ–±—Ä–µ–Ω–æ
                                {% elif p.status == 'rejected' %}–û—Ç–∫–ª–æ–Ω–µ–Ω–æ
                                {% else %}{{ p.status }}{% endif %}
                            </span>
                        </td>
                        <td>
                            <span class="status-badge {% if p.has_photo %}status-approved{% else %}status-archived{% endif %}" 
                                  style="font-size: 11px;">
                                {% if p.has_photo %}–ï—Å—Ç—å{% else %}–ù–µ—Ç{% endif %}
                            </span>
                        </td>
                        <td>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline" data-bs-toggle="dropdown">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="{{ url_for('admin.participant_detail', participant_id=p.id) }}">üëÅÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä</a></li>
                                    {% if p.status == 'pending' %}
                                    <li><a class="dropdown-item text-success" href="#" data-bs-toggle="modal" data-bs-target="#confirmationModal" data-bs-title="–û–¥–æ–±—Ä–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞?" data-bs-body="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –æ–¥–æ–±—Ä–µ–Ω–∏–µ –∑–∞—è–≤–∫–∏?" data-bs-action="{{ url_for('admin.update_single_participant_status', participant_id=p.id) }}" data-bs-fields='{"status":"approved"}'>‚úÖ –û–¥–æ–±—Ä–∏—Ç—å</a></li>
                                    <li><a class="dropdown-item text-danger" href="#" data-bs-toggle="modal" data-bs-target="#confirmationModal" data-bs-title="–û—Ç–∫–ª–æ–Ω–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞?" data-bs-body="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –∑–∞—è–≤–∫–∏?" data-bs-action="{{ url_for('admin.update_single_participant_status', participant_id=p.id) }}" data-bs-fields='{"status":"rejected"}'>‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å</a></li>
                                    {% endif %}
                                    <li><a class="dropdown-item text-danger" href="#" data-bs-toggle="modal" data-bs-target="#confirmationModal" data-bs-title="–£–¥–∞–ª–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞?" data-bs-body="–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å." data-bs-action="{{ url_for('admin.delete_participant', participant_id=p.id) }}">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</a></li>
                                </ul>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" class="text-center text-muted">–ù–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º —É—Å–ª–æ–≤–∏—è–º</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- –ú–∞—Å—Å–æ–≤—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
        <div id="bulk-actions" style="display: none; background: var(--color-primary); color: white; padding: var(--space-3);">
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <span id="selected-count">–í—ã–±—Ä–∞–Ω–æ: 0</span>
                <div>
                    <button class="btn btn-success btn-sm" id="bulk-approve">‚úÖ –û–¥–æ–±—Ä–∏—Ç—å</button>
                    <button class="btn btn-danger btn-sm" id="bulk-reject">‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // –ú–∞—Å—Å–æ–≤—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
    const selectAllCheckbox = document.getElementById('select-all');
    const rowSelects = document.querySelectorAll('.row-select');
    const bulkActions = document.getElementById('bulk-actions');
    const selectedCount = document.getElementById('selected-count');

    function updateBulkActions() {
        const checkedRows = document.querySelectorAll('.row-select:checked');
        const count = checkedRows.length;
        
        if (count > 0) {
            bulkActions.style.display = 'block';
            selectedCount.textContent = `–í—ã–±—Ä–∞–Ω–æ: ${count}`;
        } else {
            bulkActions.style.display = 'none';
        }
    }

    selectAllCheckbox?.addEventListener('change', function() {
        rowSelects.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
        updateBulkActions();
    });

    rowSelects.forEach(checkbox => {
        checkbox.addEventListener('change', updateBulkActions);
    });

    function openMassAction(status) {
        const ids = Array.from(document.querySelectorAll('.row-select:checked')).map(cb => cb.value);
        if (ids.length === 0) return;
        document.getElementById('massParticipantIds').value = ids.join(',');
        const trigger = document.createElement('button');
        trigger.setAttribute('data-bs-toggle', 'modal');
        trigger.setAttribute('data-bs-target', '#confirmationModal');
        trigger.setAttribute('data-bs-title', status === 'approved' ? '–û–¥–æ–±—Ä–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö?' : '–û—Ç–∫–ª–æ–Ω–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö?');
        trigger.setAttribute('data-bs-body', `–ë—É–¥–µ—Ç –∏–∑–º–µ–Ω–µ–Ω —Å—Ç–∞—Ç—É—Å —É ${ids.length} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤.`);
        trigger.setAttribute('data-bs-action', document.getElementById('massUpdateForm').action);
        trigger.setAttribute('data-bs-fields', JSON.stringify({ status }));
        document.body.appendChild(trigger);
        trigger.click();
        setTimeout(() => trigger.remove(), 0);
        const confirmForm = document.getElementById('confirmActionForm');
        if (confirmForm) {
            confirmForm.onsubmit = (e) => {
                e.preventDefault();
                document.getElementById('massUpdateStatus').value = status;
                document.getElementById('massUpdateForm').submit();
            };
        }
    }

    document.getElementById('bulk-approve')?.addEventListener('click', function(e) {
        e.preventDefault();
        openMassAction('approved');
    });
    document.getElementById('bulk-reject')?.addEventListener('click', function(e) {
        e.preventDefault();
        openMassAction('rejected');
    });

    // Hover —ç—Ñ—Ñ–µ–∫—Ç—ã –¥–ª—è –º–µ—Ç—Ä–∏–∫
    document.querySelectorAll('.metric-card.hover-elevate').forEach(card => {
        card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-2px)';
            this.style.boxShadow = 'var(--shadow-lg)';
        });
        
        card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
            this.style.boxShadow = 'none';
        });
    });
});
</script>
{% endblock %}

<!-- Import Modal -->
<div class="modal fade" id="importModal" tabindex="-1" aria-labelledby="importModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('admin.import_participants') }}" enctype="multipart/form-data">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <div class="modal-header">
                    <h5 class="modal-title" id="importModalLabel">–ò–º–ø–æ—Ä—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (CSV)</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="csvFile" class="form-label">CSV —Ñ–∞–π–ª</label>
                        <input type="file" class="form-control" id="csvFile" name="file" accept=".csv" required>
                        <div class="form-text">–ü–æ–ª—è: telegram_id, username, full_name, phone_number, loyalty_card, photo_path</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-primary">–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                </div>
            </form>
        </div>
    </div>
</div>