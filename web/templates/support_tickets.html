{% extends "base.html" %}

{% block title %}–ü–æ–¥–¥–µ—Ä–∂–∫–∞ - –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å{% endblock %}
{% block page_title %}–°–∏—Å—Ç–µ–º–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏{% endblock %}
{% block page_subtitle %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–∏–∫–µ—Ç–∞–º–∏ –∏ –æ–±—Ä–∞—â–µ–Ω–∏—è–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π{% endblock %}

{% block content %}
<!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–∏–∫–µ—Ç–æ–≤ -->
<div class="grid grid-cols-4 gap-4 mb-6">
    <div class="card metric-card hover-elevate">
        <div class="card-body">
            <div class="metric-title">–û—Ç–∫—Ä—ã—Ç—ã–µ —Ç–∏–∫–µ—Ç—ã</div>
            <div class="metric-value">{{ (stats.open_tickets or 0) if stats else 0 }}</div>
            <div class="metric-subtitle">–¢—Ä–µ–±—É—é—Ç –≤–Ω–∏–º–∞–Ω–∏—è</div>
            <i class="fas fa-headset metric-icon"></i>
        </div>
    </div>
    <div class="card metric-card hover-elevate">
        <div class="card-body">
            <div class="metric-title">–í —Ä–∞–±–æ—Ç–µ</div>
            <div class="metric-value">{{ (stats.tickets_in_progress or 0) if stats else 0 }}</div>
            <div class="metric-subtitle">–ù–∞–∑–Ω–∞—á–µ–Ω—ã –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞–º</div>
            <i class="fas fa-clock metric-icon"></i>
        </div>
    </div>
    <div class="card metric-card hover-elevate">
        <div class="card-body">
            <div class="metric-title">–ó–∞–∫—Ä—ã—Ç–æ</div>
            <div class="metric-value">{{ (stats.tickets_closed or 0) if stats else 0 }}</div>
            <div class="metric-subtitle">–ó–∞ –≤—Å—ë –≤—Ä–µ–º—è</div>
            <i class="fas fa-check-circle metric-icon"></i>
        </div>
    </div>
    <div class="card metric-card hover-elevate">
        <div class="card-body">
            <div class="metric-title">–ù–µ—É–¥–∞—á–Ω—ã—Ö —Ä–∞—Å—Å—ã–ª–æ–∫</div>
            <div class="metric-value">{{ (stats.failed_broadcasts or 0) if stats else 0 }}</div>
            <div class="metric-subtitle">–¢—Ä–µ–±—É—é—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏</div>
            <i class="fas fa-triangle-exclamation metric-icon"></i>
        </div>
    </div>
</div>

<!-- –§–∏–ª—å—Ç—Ä—ã -->
<div class="card mb-6">
    <div class="card-header">
        <h2 class="card-title">–§–∏–ª—å—Ç—Ä—ã</h2>
    </div>
    <div class="card-body">
        <form method="GET" class="grid grid-cols-3 gap-4">
            <div class="form-group">
                <label class="form-label">–°—Ç–∞—Ç—É—Å</label>
                <select name="status" class="form-control">
                    <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                    <option value="open" {% if status == 'open' %}selected{% endif %}>–û—Ç–∫—Ä—ã—Ç</option>
                    <option value="in_progress" {% if status == 'in_progress' %}selected{% endif %}>–í —Ä–∞–±–æ—Ç–µ</option>
                    <option value="closed" {% if status == 'closed' %}selected{% endif %}>–ó–∞–∫—Ä—ã—Ç</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label>
                <select name="priority" class="form-control">
                    <option value="">–í—Å–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã</option>
                    <option value="urgent">–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π</option>
                    <option value="high">–í—ã—Å–æ–∫–∏–π</option>
                    <option value="medium">–°—Ä–µ–¥–Ω–∏–π</option>
                    <option value="low">–ù–∏–∑–∫–∏–π</option>
                </select>
            </div>
            <div class="form-group d-flex align-items-end">
                <button type="submit" class="btn btn-primary">üîç –§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å</button>
                <a href="{{ url_for('admin.support_tickets') }}" class="btn btn-outline ms-2">–û—á–∏—Å—Ç–∏—Ç—å</a>
            </div>
        </form>
    </div>
</div>

<!-- –°–ø–∏—Å–æ–∫ —Ç–∏–∫–µ—Ç–æ–≤ -->
<div class="card">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h2 class="card-title">
                –¢–∏–∫–µ—Ç—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏
                {% if status %}
                    - <span class="status-badge status-{{ status }}">
                        {% if status == 'open' %}–û—Ç–∫—Ä—ã—Ç
                        {% elif status == 'in_progress' %}–í —Ä–∞–±–æ—Ç–µ
                        {% elif status == 'closed' %}–ó–∞–∫—Ä—ã—Ç
                        {% endif %}
                    </span>
                {% endif %}
            </h2>
            <div class="d-flex gap-2">
                <span class="badge badge-notification">{{ tickets|length if tickets else 5 }} –Ω–æ–≤—ã—Ö</span>
            </div>
        </div>
    </div>
    <div class="card-body">
        {% if tickets %}
            {% for ticket in tickets %}
            <div class="support-ticket mb-4">
                <div class="ticket-header">
                    <h3 class="ticket-title">{{ ticket.subject or ticket.title or '–ë–µ–∑ —Ç–µ–º—ã' }}</h3>
                    <div class="d-flex gap-2">
                        <span class="status-badge status-{{ ticket.status or 'open' }}">
                            {% if ticket.status == 'open' %}–û—Ç–∫—Ä—ã—Ç
                            {% elif ticket.status == 'in_progress' %}–í —Ä–∞–±–æ—Ç–µ  
                            {% elif ticket.status == 'closed' %}–ó–∞–∫—Ä—ã—Ç
                            {% else %}{{ ticket.status }}
                            {% endif %}
                        </span>
                        <span class="status-badge priority-{{ ticket.priority or 'medium' }}">
                            {{ ticket.priority or 'medium' }}
                        </span>
                        <span class="status-badge status-archived">{{ ticket.category or '–û–±—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã' }}</span>
                    </div>
                </div>
                <div class="ticket-content">
                    <p class="ticket-description">
                        {{ ticket.message or '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç' }}
                    </p>
                    <div class="ticket-meta">
                        <span><i class="fas fa-user"></i> {{ ticket.user_name or ticket.full_name or '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π' }}</span>
                        <span><i class="fas fa-clock"></i> {{ (ticket.created_at or ticket.timestamp)|moscow_time or '–î–∞—Ç–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞' }}</span>
                        {% if ticket.assigned_to %}
                        <span><i class="fas fa-user-tie"></i> {{ ticket.assigned_to }}</span>
                        {% endif %}
                    </div>
            <div class="ticket-actions">
                        <button class="btn btn-sm btn-primary" data-action="reply">üì§ –û—Ç–≤–µ—Ç–∏—Ç—å</button>
                        <a href="{{ url_for('admin.support_ticket_detail', ticket_id=ticket.id) }}" class="btn btn-sm btn-outline">üëÅÔ∏è –ü–æ–¥—Ä–æ–±–Ω–µ–µ</a>
                        {% if ticket.status == 'open' %}
                        <button class="btn btn-sm btn-success" data-action="take">üë§‚úÖ –í–∑—è—Ç—å –≤ —Ä–∞–±–æ—Ç—É</button>
                        {% elif ticket.status == 'in_progress' %}
                        <button class="btn btn-sm btn-success" data-action="close">–ó–∞–∫—Ä—ã—Ç—å</button>
                        {% endif %}
                        <button class="btn btn-sm btn-outline-danger" 
                                data-bs-toggle="modal" 
                                data-bs-target="#confirmationModal"
                                data-bs-title="–£–¥–∞–ª–∏—Ç—å —Ç–∏–∫–µ—Ç?"
                                data-bs-body="–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å. –¢–∏–∫–µ—Ç –∏ –≤—Å–µ –µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã."
                                data-bs-action="{{ url_for('admin.delete_support_ticket', ticket_id=ticket.id) }}"
                                title="–£–¥–∞–ª–∏—Ç—å —Ç–∏–∫–µ—Ç">
                            <i class="fas fa-trash"></i> –£–¥–∞–ª–∏—Ç—å
                        </button>
                        <form class="d-none" method="POST" action="{{ url_for('admin.update_ticket_status', ticket_id=ticket.id) }}">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <input type="hidden" name="status" value=""/>
                            <input type="hidden" name="response_message" value=""/>
                        </form>
                    </div>
            {% if ticket.status == 'closed' and ticket.updated_at %}
            <div class="text-muted small mt-2">–ó–∞–∫—Ä—ã—Ç: {{ ticket.updated_at|moscow_time }}</div>
            {% endif %}
                </div>
            </div>
            {% endfor %}
        {% else %}
        <!-- –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ–≥–¥–∞ –Ω–µ—Ç —Ç–∏–∫–µ—Ç–æ–≤ -->
        <div class="empty-state text-center py-5">
            <div class="empty-icon mb-3">
                <i class="fas fa-inbox fa-3x text-muted"></i>
            </div>
            <h4 class="text-muted">–¢–∏–∫–µ—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h4>
            <p class="text-muted mb-4">
                {% if request.args.get('search') %}
                    –ü–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É "{{ request.args.get('search') }}" –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.
                    <br><a href="{{ url_for('admin.support_tickets') }}" class="text-primary">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —Ç–∏–∫–µ—Ç—ã</a>
                {% else %}
                    –í—Å–µ —Ç–∏–∫–µ—Ç—ã –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã –∏–ª–∏ –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–Ω—ã.
                {% endif %}
            </p>
        </div>
        {% endif %}
    </div>
</div>

<!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
{% if pages and pages > 1 %}
<div class="card mt-4">
    <div class="card-body">
        <nav aria-label="–ü–∞–≥–∏–Ω–∞—Ü–∏—è —Ç–∏–∫–µ—Ç–æ–≤">
            <ul class="pagination justify-content-center mb-0">
                <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ participants.html -->
                <li class="page-item active">
                    <span class="page-link">1</span>
                </li>
            </ul>
        </nav>
        <div class="text-center text-muted mt-3">
            –ü–æ–∫–∞–∑–∞–Ω–æ —Ç–∏–∫–µ—Ç–æ–≤: {{ tickets|length if tickets else 3 }} –∏–∑ {{ total or 3 }}
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Hover —ç—Ñ—Ñ–µ–∫—Ç—ã –¥–ª—è –º–µ—Ç—Ä–∏–∫
    document.querySelectorAll('.metric-card.hover-elevate').forEach(card => {
        card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-2px)';
            this.style.boxShadow = 'var(--shadow-lg)';
        });
        
        card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
            this.style.boxShadow = 'none';
        });
    });

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫ —Ç–∏–∫–µ—Ç–æ–≤
    document.querySelectorAll('.ticket-actions .btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            const action = this.getAttribute('data-action');
            if (action === 'reply') {
                e.preventDefault();
                const ticketContent = this.closest('.ticket-content');
                showReplyForm(ticketContent);
            } else if (action === 'take') {
                e.preventDefault();
                submitTicketStatusAjax(this, 'in_progress');
            } else if (action === 'close') {
                e.preventDefault();
                submitTicketStatusAjax(this, 'closed');
            }
        });
    });
});

function showReplyForm(ticketContent) {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ —Ñ–æ—Ä–º–∞
    if (ticketContent.querySelector('.reply-form')) return;
    
    const replyForm = document.createElement('div');
    replyForm.className = 'reply-form';
    replyForm.style.marginTop = 'var(--space-4)';
    replyForm.innerHTML = `
        <div style="border: 1px solid var(--color-gray-200); border-radius: var(--radius-md); padding: var(--space-4); background: var(--color-gray-50);">
            <label class="form-label">–í–∞—à –æ—Ç–≤–µ—Ç:</label>
            <textarea class="form-control" rows="3" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é..."></textarea>
            <div style="margin-top: var(--space-3); display: flex; gap: var(--space-2);">
                <button class="btn btn-primary btn-sm" onclick="sendReply(this)">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                <button class="btn btn-outline btn-sm" onclick="cancelReply(this)">–û—Ç–º–µ–Ω–∞</button>
            </div>
            <div style="margin-top: var(--space-3); display: flex; flex-wrap: wrap; gap: var(--space-2);">
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="fillQuickReply(this, '–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –í–∑—è–ª–∏ –≤–∞—à–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ –≤ —Ä–∞–±–æ—Ç—É. –û—Ç–≤–µ—Ç–∏–º –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.')">–í–∑—è–ª–∏ –≤ —Ä–∞–±–æ—Ç—É</button>
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="fillQuickReply(this, '–ì–æ—Ç–æ–≤–æ! –ú—ã –∑–∞–∫—Ä—ã–ª–∏ –≤–∞—à–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ. –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –ø–æ–≤—Ç–æ—Ä–∏—Ç—Å—è ‚Äî –æ—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ.')">–ó–∞–∫—Ä—ã—Ç–æ</button>
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="fillQuickReply(this, '–ù—É–∂–Ω—ã —É—Ç–æ—á–Ω–µ–Ω–∏—è: –ø—Ä–∏—à–ª–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–∫—Ä–∏–Ω—à–æ—Ç/—Ñ–æ—Ç–æ —á–µ–∫–∞, —á—Ç–æ–±—ã –º—ã –ø–æ–º–æ–≥–ª–∏ –±—ã—Å—Ç—Ä–µ–µ.')">–ù—É–∂–Ω—ã —É—Ç–æ—á–Ω–µ–Ω–∏—è</button>
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="fillQuickReply(this, '–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ä–∞–±–æ—Ç—ã. –ü—Ä–æ–±–ª–µ–º–∞ –≤—Ä–µ–º–µ–Ω–Ω–∞—è, —É–∂–µ —á–∏–Ω–∏–º. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —á—É—Ç—å –ø–æ–∑–∂–µ.')">–¢–µ—Ö—Ä–∞–±–æ—Ç—ã</button>
            </div>
        </div>
    `;
    
    ticketContent.appendChild(replyForm);
    replyForm.querySelector('textarea').focus();
}

async function sendReply(btn) {
    const textarea = btn.parentNode.parentNode.querySelector('textarea');
    const message = textarea.value.trim();
    
    if (!message) {
        notyf.error('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞');
        return;
    }
    const ticket = btn.closest('.support-ticket');
    const id = ticket?.querySelector('[data-ticket-id]')?.getAttribute('data-ticket-id') || ticket?.previousElementSibling?.getAttribute('data-ticket-id')
    const container = btn.closest('.ticket-content');
    const replyContainer = btn.closest('.reply-form');
    // Fallback: find from actions link
    const detailLink = ticket.querySelector('a[href*="/support_tickets/"]');
    const match = detailLink?.href.match(/\/support_tickets\/(\d+)/);
    const ticketId = match ? match[1] : null;
    try {
        const res = await fetch(`/admin/support_tickets/${ticketId}/status`, {
            method: 'POST',
            headers: { 
                'Accept': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: (() => { 
                const fd = new FormData(); 
                fd.append('status','in_progress'); 
                fd.append('response_message', message); 
                fd.append('csrf_token', window.CSRF_TOKEN||''); 
                return fd; 
            })()
        });
        
        const data = await res.json().catch(() => ({}));
        
        if (!res.ok) {
            throw new Error(data.error || data.message || `HTTP ${res.status}: ${res.statusText}`);
        }
        
        if (!data.ok) {
            throw new Error(data.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
        }
        
        const statusBadge = ticket.querySelector('.status-badge:first-child');
        if (statusBadge) {
            statusBadge.className = 'status-badge status-in-progress';
            statusBadge.textContent = '–í —Ä–∞–±–æ—Ç–µ';
        }
        
        notyf.success('–û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω, —Å—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω');
        replyContainer.remove();
    } catch (e) {
        console.error('Reply error:', e);
        notyf.error(`–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞: ${e.message}`);
    }
}

function cancelReply(btn) {
    const replyForm = btn.closest('.reply-form');
    replyForm.remove();
}

function fillQuickReply(btn, text) {
    const container = btn.closest('.reply-form');
    const ta = container?.querySelector('textarea');
    if (ta) { ta.value = text; ta.focus(); ta.selectionStart = ta.value.length; ta.selectionEnd = ta.value.length; }
}

async function submitTicketStatusAjax(btn, status) {
    const ticket = btn.closest('.support-ticket');
    const detailLink = ticket.querySelector('a[href*="/support_tickets/"]');
    const match = detailLink?.href.match(/\/support_tickets\/(\d+)/);
    const ticketId = match ? match[1] : null;
    if (!ticketId) return;
    try {
        const res = await fetch(`/admin/support_tickets/${ticketId}/status`, {
            method: 'POST',
            headers: { 
                'Accept': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: (() => { 
                const fd = new FormData(); 
                fd.append('status', status); 
                fd.append('csrf_token', window.CSRF_TOKEN||''); 
                return fd; 
            })()
        });
        
        const data = await res.json().catch(() => ({}));
        
        if (!res.ok) {
            throw new Error(data.error || data.message || `HTTP ${res.status}: ${res.statusText}`);
        }
        
        if (!data.ok) {
            throw new Error(data.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
        }
        
        const statusBadge = ticket.querySelector('.status-badge:first-child');
        if (statusBadge) {
            if (status === 'in_progress') { 
                statusBadge.className = 'status-badge status-in-progress'; 
                statusBadge.textContent = '–í —Ä–∞–±–æ—Ç–µ'; 
            }
            if (status === 'closed') { 
                statusBadge.className = 'status-badge status-archived'; 
                statusBadge.textContent = '–ó–∞–∫—Ä—ã—Ç'; 
            }
        }
        
        notyf.success('–°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω');
    } catch (e) {
        console.error('Status update error:', e);
        notyf.error(`–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞: ${e.message}`);
    }
}
</script>
{% endblock %}