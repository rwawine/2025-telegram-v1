{% extends "base.html" %}

{% block title %}–ú–æ–¥–µ—Ä–∞—Ü–∏—è{% endblock %}
{% block page_title %}–ú–æ–¥–µ—Ä–∞—Ü–∏—è –∑–∞—è–≤–æ–∫{% endblock %}
{% block page_subtitle %}–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –¥–ª—è –Ω–æ–≤—ã—Ö –∑–∞—è–≤–æ–∫{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h2 class="card-title mb-0">–ù–æ–≤—ã–µ –∑–∞—è–≤–∫–∏</h2>
        <a class="btn btn-outline btn-sm" href="{{ url_for('admin.participants', status='pending') }}">–û—Ç–∫—Ä—ã—Ç—å —Å–ø–∏—Å–æ–∫</a>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>–£—á–∞—Å—Ç–Ω–∏–∫</th>
                        <th>–ö–æ–Ω—Ç–∞–∫—Ç—ã</th>
                        <th>–î–∞—Ç–∞</th>
                        <th>–§–æ—Ç–æ</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody>
                    {% for p in participants %}
                    <tr>
                        <td>
                            <div style="font-weight: 600;">{{ p.full_name }}</div>
                            <div class="text-mono" style="font-size: 12px; color: var(--color-gray-500);">ID: {{ p.id }}</div>
                        </td>
                        <td class="small">{{ p.phone_number }}<br>@{{ p.username }}</td>
                        <td>{{ p.registration_date|moscow_time }}</td>
                        <td>
                            {% if p.photo_path %}
                                <div class="d-flex align-items-center">
                                    {% set photo_basename = p.photo_path.split('/')[-1].split('\\')[-1] %}
                                    <img src="{{ url_for('admin.serve_upload', filename=photo_basename) }}" 
                                         alt="–§–æ—Ç–æ" 
                                         class="photo-preview-trigger me-2" 
                                         style="width: 32px; height: 32px; object-fit: cover; border-radius: 4px; cursor: pointer;"
                                         data-photo-src="{{ url_for('admin.serve_upload', filename=photo_basename) }}"
                                         data-participant-name="{{ p.full_name or ('ID ' ~ p.id) }}">
                                    <span class="status-badge status-approved" style="font-size: 11px;">–ï—Å—Ç—å</span>
                                </div>
                            {% else %}
                                <span class="status-badge status-archived" style="font-size: 11px;">–ù–µ—Ç</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group">
                                <a class="btn btn-sm btn-outline" href="{{ url_for('admin.participant_detail', participant_id=p.id) }}">üëÅÔ∏è</a>
                                <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#confirmationModal" data-bs-title="–û–¥–æ–±—Ä–∏—Ç—å?" data-bs-body="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –æ–¥–æ–±—Ä–µ–Ω–∏–µ –∑–∞—è–≤–∫–∏?" data-bs-action="{{ url_for('admin.update_single_participant_status', participant_id=p.id) }}" data-bs-fields='{"status":"approved"}'>‚úÖ</button>
                                <div class="btn-group">
                                    <button class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#confirmationModal" data-bs-title="–û—Ç–∫–ª–æ–Ω–∏—Ç—å?" data-bs-body='<div class="mb-2">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –∏–ª–∏ —É–∫–∞–∂–∏—Ç–µ —Å–≤–æ—é:</div>
<div class="d-grid gap-2 mb-2">
<button type="button" class="btn btn-outline-secondary btn-sm" onclick="document.querySelector(`#confirmActionForm input[name=notes]`)?.setAttribute(`value`,`–ù–µ—á–µ—Ç–∫–æ–µ —Ñ–æ—Ç–æ –ª–∏—Ñ–ª–µ—Ç–∞.`)">üì∑ –ù–µ—á–µ—Ç–∫–æ–µ —Ñ–æ—Ç–æ</button>
<button type="button" class="btn btn-outline-secondary btn-sm" onclick="document.querySelector(`#confirmActionForm input[name=notes]`)?.setAttribute(`value`,`–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.`)">üìù –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</button>
<button type="button" class="btn btn-outline-secondary btn-sm" onclick="document.querySelector(`#confirmActionForm input[name=notes]`)?.setAttribute(`value`,`–ö–∞—Ä—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.`)">üí≥ –ö–∞—Ä—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞</button>
<button type="button" class="btn btn-outline-secondary btn-sm" onclick="document.querySelector(`#confirmActionForm input[name=notes]`)?.setAttribute(`value`,`–ù–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª.`)">‚ö†Ô∏è –ù–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª</button>
</div>
<input type="text" class="form-control" placeholder="–°–≤–æ—è –ø—Ä–∏—á–∏–Ω–∞" oninput="document.querySelector(`#confirmActionForm input[name=notes]`)?.setAttribute(`value`, this.value)">' data-bs-action="{{ url_for('admin.update_single_participant_status', participant_id=p.id) }}" data-bs-fields='{"status":"rejected","notes":""}'>‚ùå</button>
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="5" class="text-center text-muted">–ù–µ—Ç –Ω–æ–≤—ã—Ö –∑–∞—è–≤–æ–∫</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
<!-- Photo Modal -->
<div class="modal fade" id="photoModal" tabindex="-1" aria-labelledby="photoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="photoModalLabel">–§–æ—Ç–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞</h5>
                <button type="button" class="btn-close" onclick="closePhotoModal()" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <img id="modalPhotoImg" src="" alt="–§–æ—Ç–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞" class="img-fluid rounded shadow" style="max-height: 70vh; max-width: 100%;">
                <div class="mt-3">
                    <button type="button" class="btn btn-outline-primary" onclick="openPhotoInNewTab()">
                        <i class="fas fa-external-link-alt me-1"></i>–û—Ç–∫—Ä—ã—Ç—å –≤ –ø–æ–ª–Ω–æ–º —Ä–∞–∑–º–µ—Ä–µ
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function(){
    // Add click handlers to all photo previews
    document.querySelectorAll('.photo-preview-trigger').forEach(function(img) {
        img.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const modalImg = document.getElementById('modalPhotoImg');
            const modalTitle = document.getElementById('photoModalLabel');
            const modal = document.getElementById('photoModal');
            const participantName = this.getAttribute('data-participant-name') || '–£—á–∞—Å—Ç–Ω–∏–∫';
            const photoSrc = this.getAttribute('data-photo-src') || this.src;
            
            if (!modal) return;
            
            if (modalImg) {
                modalImg.src = photoSrc;
                modalImg.alt = `–§–æ—Ç–æ ${participantName}`;
                modalImg.setAttribute('data-full-src', photoSrc);
            }
            
            if (modalTitle) {
                modalTitle.textContent = `–§–æ—Ç–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞: ${participantName}`;
            }
            
            // Show modal
            modal.style.display = 'block';
            modal.classList.add('show');
            document.body.classList.add('modal-open');
            
            // Remove old backdrop if exists
            const oldBackdrop = document.getElementById('photoModalBackdrop');
            if (oldBackdrop) oldBackdrop.remove();
            
            // Add backdrop
            const backdrop = document.createElement('div');
            backdrop.className = 'modal-backdrop fade show';
            backdrop.id = 'photoModalBackdrop';
            document.body.appendChild(backdrop);
        });
    });
    
    // Add event listeners for modal close
    const modal = document.getElementById('photoModal');
    if (modal) {
        // Close on backdrop click
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closePhotoModal();
            }
        });
        
        // Close on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && modal.classList.contains('show')) {
                closePhotoModal();
            }
        });
    }
});

// Open photo in new tab
window.openPhotoInNewTab = function() {
    const modalImg = document.getElementById('modalPhotoImg');
    if (modalImg && modalImg.getAttribute('data-full-src')) {
        window.open(modalImg.getAttribute('data-full-src'), '_blank');
    }
};

// Close photo modal manually
window.closePhotoModal = function() {
    const modal = document.getElementById('photoModal');
    const backdrop = document.getElementById('photoModalBackdrop');
    
    if (modal) {
        modal.style.display = 'none';
        modal.classList.remove('show');
        document.body.classList.remove('modal-open');
    }
    
    if (backdrop) {
        backdrop.remove();
    }
};
</script>
{% endblock %}


